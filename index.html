<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>公文發文系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase 設定 ---
        // 注意：在正式部署時，這部分會自動使用環境變數或你設定的金鑰
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // Gemini API Key

        // --- 輔助：圖示元件 (使用 SVG 避免依賴外部庫) ---
        const Icon = ({ d, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {d}
            </svg>
        );
        const Icons = {
            Menu: <path d="M4 6h16M4 12h16M4 18h16" />,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></>,
            Search: <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
            Edit: <><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></>,
            Plus: <path d="M5 12h14M12 5v14" />,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></>,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            Check: <path d="M20 6 9 17l-5-5" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />,
            Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
            Briefcase: <><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>,
            Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></>,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
            ClipboardList: <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>
        };

        // --- Gemini API ---
        async function callGemini(prompt) {
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                console.error("Gemini API Error:", error);
                alert("AI 服務暫時無法使用，請稍後再試。");
                return null;
            }
        }

        // --- Constants ---
        const INITIAL_AUTHORS = ['黃〇〇', '吳〇〇', '謝〇〇', '陳〇〇'];
        const INITIAL_CODES = ['陸十平武', '陸十軍人', '陸十軍補', '陸十軍情'];
        const ADMIN_TYPES = {
            general: { label: '一般公文', prefix: '' },
            award: { label: '獎懲業務', prefix: '人勤令' },
            transfer: { label: '調職/晉升', prefix: '人職令' },
        };
        const RANKS = [
            { id: 'officer', label: '軍官', short: '官' },
            { id: 'nco', label: '士官', short: '士' },
            { id: 'soldier', label: '士兵', short: '兵' },
        ];

        // --- Main Component ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [records, setRecords] = React.useState([]);
            const [authorsList, setAuthorsList] = React.useState(INITIAL_AUTHORS);
            const [codesList, setCodesList] = React.useState(INITIAL_CODES);
            const [authorDefaults, setAuthorDefaults] = React.useState({}); // 承辦人預設值 { "黃〇〇": "陸十平武" }

            const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
            const [isSettingsMode, setIsSettingsMode] = React.useState(false); // 側邊欄設定模式
            const [selectedOfficer, setSelectedOfficer] = React.useState('所有');
            const [editingDefaultAuthor, setEditingDefaultAuthor] = React.useState(null); // 正在設定預設值的人員
            const [tempDefaultCode, setTempDefaultCode] = React.useState("");

            const [isAiLoading, setIsAiLoading] = React.useState(false);
            const [showSmartFillModal, setShowSmartFillModal] = React.useState(false);
            const [smartFillText, setSmartFillText] = React.useState("");

            const [formData, setFormData] = React.useState({
                id: null, date: new Date().toISOString().split('T')[0], author: '', code: '', number: '', subject: ''
            });
            
            const [adminType, setAdminType] = React.useState('general');
            const [selectedRank, setSelectedRank] = React.useState(null);
            const [adminNumber, setAdminNumber] = React.useState('');
            
            const [searchMode, setSearchMode] = React.useState(false);
            const [searchQuery, setSearchQuery] = React.useState("");
            const [sortOrder, setSortOrder] = React.useState('newest'); // 'newest' | 'oldest'

            // --- Auth & Data Sync ---
            React.useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                if (!user) return;
                
                // Sync Records
                const qRecords = collection(db, 'artifacts', appId, 'users', user.uid, 'records');
                const unsubRecords = onSnapshot(qRecords, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRecords(data);
                });

                // Sync Settings (Lists & Defaults)
                const qSettings = collection(db, 'artifacts', appId, 'users', user.uid, 'settings');
                const unsubSettings = onSnapshot(qSettings, (snapshot) => {
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (doc.id === 'lists') {
                            if (data.authors) setAuthorsList(data.authors);
                            if (data.codes) setCodesList(data.codes);
                        }
                        if (doc.id === 'defaults') {
                            setAuthorDefaults(data);
                        }
                    });
                });

                return () => { unsubRecords(); unsubSettings(); };
            }, [user]);

            // --- Logic ---
            const generateNextNumber = (currentRecords) => {
                const today = new Date();
                const rocYear = today.getFullYear() - 1911;
                const prefix = `${rocYear}`;
                const relevantNumbers = currentRecords
                    .map(r => r.number)
                    .filter(n => n && n.toString().startsWith(prefix))
                    .map(n => parseInt(n, 10))
                    .filter(n => !isNaN(n));
                if (relevantNumbers.length === 0) return `${prefix}0000001`;
                const maxNum = Math.max(...relevantNumbers);
                return (maxNum + 1).toString();
            };

            const generateNextAdminNumber = (currentRecords, typeKey, rankId) => {
                const prefix = ADMIN_TYPES[typeKey]?.prefix;
                const rankShort = RANKS.find(r => r.id === rankId)?.short;
                if (!prefix || !rankShort) return '001';
                const targetStart = `${prefix}(${rankShort})`;
                const relevantNumbers = currentRecords
                    .filter(r => r.adminTag && r.adminTag.startsWith(targetStart))
                    .map(r => parseInt(r.adminTag.replace(targetStart, '').replace('號', ''), 10))
                    .filter(n => !isNaN(n));
                if (relevantNumbers.length === 0) return '001';
                return (Math.max(...relevantNumbers) + 1).toString().padStart(3, '0');
            };

            const filteredRecords = React.useMemo(() => {
                let result = [...records];
                if (selectedOfficer !== '所有') result = result.filter(r => r.author === selectedOfficer);
                if (searchMode && searchQuery) {
                    result = result.filter(r => r.subject.includes(searchQuery) || r.number.includes(searchQuery) || r.code.includes(searchQuery));
                }
                result.sort((a, b) => {
                    const numA = parseInt(a.number, 10);
                    const numB = parseInt(b.number, 10);
                    if (!isNaN(numA) && !isNaN(numB)) return sortOrder === 'newest' ? numB - numA : numA - numB;
                    return sortOrder === 'newest' ? String(b.number).localeCompare(String(a.number)) : String(a.number).localeCompare(String(b.number));
                });
                return result;
            }, [records, selectedOfficer, searchMode, searchQuery, sortOrder]);

            const getAdminTagString = () => {
                if (adminType === 'general' || !selectedRank || !adminNumber) return '';
                const prefix = ADMIN_TYPES[adminType].prefix;
                const rankShort = RANKS.find(r => r.id === selectedRank)?.short || '';
                return `${prefix}(${rankShort})${adminNumber}號`;
            };

            // --- Handlers ---
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                
                // 承辦人預設值邏輯
                if (name === 'author' && authorDefaults[value]) {
                     setFormData(prev => ({ ...prev, [name]: value, code: authorDefaults[value] }));
                } else {
                     setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleAddItem = async (type) => {
                const isAuthor = type === 'author';
                const list = isAuthor ? authorsList : codesList;
                const newVal = prompt(`請輸入新項目：`);
                if (newVal && !list.includes(newVal)) {
                    const newList = [...list, newVal];
                    // Update Cloud
                    const listRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'lists');
                    await setDoc(listRef, { [isAuthor ? 'authors' : 'codes']: newList }, { merge: true });
                    setFormData(prev => ({ ...prev, [type]: newVal }));
                }
            };

            const handleDeleteItem = async (type) => {
                const val = formData[type];
                if (!val) return;
                const isAuthor = type === 'author';
                const list = isAuthor ? authorsList : codesList;
                if (list.includes(val) && confirm(`確認刪除 ${val}?`)) {
                    const newList = list.filter(i => i !== val);
                    const listRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'lists');
                    await setDoc(listRef, { [isAuthor ? 'authors' : 'codes']: newList }, { merge: true });
                    setFormData(prev => ({ ...prev, [type]: '' }));
                }
            };

            // 儲存承辦人預設值
            const saveAuthorDefault = async () => {
                if (editingDefaultAuthor && tempDefaultCode) {
                    const newDefaults = { ...authorDefaults, [editingDefaultAuthor]: tempDefaultCode };
                    const defaultsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'defaults');
                    await setDoc(defaultsRef, newDefaults, { merge: true });
                    alert(`已儲存 ${editingDefaultAuthor} 的預設代字為：${tempDefaultCode}`);
                    setEditingDefaultAuthor(null);
                }
            };

            const handleRegister = async () => {
                if (!formData.date || !formData.author || !formData.code) return alert("請填寫必要欄位");
                
                let finalNumber = formData.number || generateNextNumber(records);
                let finalAdminTag = '';
                
                if (adminType !== 'general') {
                    if (!selectedRank) return alert("請選擇身分");
                    let finalAdminNum = adminNumber || generateNextAdminNumber(records, adminType, selectedRank);
                    finalAdminTag = `${ADMIN_TYPES[adminType].prefix}(${RANKS.find(r=>r.id===selectedRank)?.short})${finalAdminNum}號`;
                }

                const newRecord = { ...formData, number: finalNumber, adminTag: finalAdminTag, createdAt: new Date().toISOString() };
                delete newRecord.id;
                
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'records'), newRecord);
                alert(`登錄成功！字號：${finalNumber}`);
                setFormData(prev => ({ ...prev, id: null, number: '', subject: '' }));
                setAdminNumber('');
            };

            const handleUpdate = async () => {
                if (!formData.id) return alert("請選擇紀錄");
                const { id, ...data } = formData;
                data.adminTag = getAdminTagString();
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'records', id), data);
                alert("更新成功");
                setFormData({ ...formData, id: null, number: '', subject: '' });
                setAdminNumber('');
            };

            const handleCopy = (record) => {
                const dateParts = record.date.split('-');
                const formattedDate = dateParts.length === 3 ? `${dateParts[1]}月${dateParts[2]}日` : record.date;
                const shortNumber = record.number.slice(-3);
                const text = `${formattedDate}${shortNumber}號${record.subject} ${record.adminTag || ''}`;
                navigator.clipboard.writeText(text).then(() => alert("已複製！"));
            };

            const handleSmartFill = async () => {
                if (!smartFillText) return;
                setIsAiLoading(true);
                const res = await callGemini(`分析以下文字並回傳 JSON {date, author, code, number, subject}: ${smartFillText}`);
                if (res) {
                    try {
                        const data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, ''));
                        setFormData(prev => ({ ...prev, ...data }));
                        setShowSmartFillModal(false);
                        setSmartFillText("");
                    } catch (e) { alert("AI 解析失敗"); }
                }
                setIsAiLoading(false);
            };

            if (!user) return <div className="h-screen flex items-center justify-center text-slate-500">載入中...</div>;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 relative">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white transform transition-transform duration-300 shadow-2xl ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-5 flex justify-between items-center border-b border-slate-700">
                            <h2 className="font-bold flex items-center gap-2"><Icon d={Icons.User} /> 承辦人</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setIsSettingsMode(!isSettingsMode)} className={`p-1 rounded ${isSettingsMode ? 'bg-amber-500' : 'text-slate-400'}`}><Icon d={Icons.Settings}/></button>
                                <button onClick={() => setIsSidebarOpen(false)}><Icon d={Icons.X} /></button>
                            </div>
                        </div>
                        {isSettingsMode && <div className="px-4 py-2 bg-amber-900/30 text-amber-200 text-xs text-center">點擊人員以設定預設代字</div>}
                        <div className="p-4 space-y-2">
                            {['所有', ...authorsList].map(name => (
                                <button key={name} 
                                    onClick={() => {
                                        if (isSettingsMode) {
                                            if (name !== '所有') { setEditingDefaultAuthor(name); setTempDefaultCode(authorDefaults[name] || ""); }
                                        } else {
                                            setSelectedOfficer(name); setIsSidebarOpen(false); 
                                        }
                                    }}
                                    className={`w-full text-left px-4 py-3 rounded-lg flex justify-between items-center ${selectedOfficer === name && !isSettingsMode ? 'bg-blue-600' : 'hover:bg-slate-700'}`}
                                >
                                    <span className="flex items-center gap-2">
                                        {name}
                                        {isSettingsMode && name !== '所有' && authorDefaults[name] && <span className="text-[10px] bg-slate-600 px-1 rounded">{authorDefaults[name]}</span>}
                                    </span>
                                    {!isSettingsMode && selectedOfficer === name && <Icon d={Icons.Check} size={16} />}
                                    {isSettingsMode && name !== '所有' && <Icon d={Icons.Edit} size={14} className="opacity-50" />}
                                </button>
                            ))}
                        </div>
                    </div>
                    {(isSidebarOpen || showSmartFillModal || editingDefaultAuthor) && <div className="fixed inset-0 bg-black/50 z-40" onClick={() => { setIsSidebarOpen(false); setShowSmartFillModal(false); setEditingDefaultAuthor(null); }} />}

                    {/* Default Settings Modal */}
                    {editingDefaultAuthor && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
                            <div className="bg-white w-full max-w-xs rounded-xl p-5 shadow-2xl pointer-events-auto space-y-4">
                                <h3 className="font-bold flex items-center gap-2"><Icon d={Icons.Settings} className="text-amber-500"/> 設定預設值</h3>
                                <p className="text-sm text-slate-600">設定 <b>{editingDefaultAuthor}</b> 的預設代字：</p>
                                <input list="codes-settings" className="w-full p-2 border rounded" value={tempDefaultCode} onChange={e => setTempDefaultCode(e.target.value)} placeholder="選擇或輸入" />
                                <datalist id="codes-settings">{codesList.map(c => <option key={c} value={c} />)}</datalist>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setEditingDefaultAuthor(null)} className="px-3 py-1 text-slate-500">取消</button>
                                    <button onClick={saveAuthorDefault} className="px-3 py-1 bg-amber-500 text-white rounded flex items-center gap-1"><Icon d={Icons.Save} size={16}/> 儲存</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* AI Modal */}
                    {showSmartFillModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-2xl p-6 shadow-xl space-y-4">
                                <div className="flex justify-between items-center border-b pb-2">
                                    <h3 className="font-bold text-purple-600 flex items-center gap-2"><Icon d={Icons.Sparkles} /> AI 智慧填表</h3>
                                    <button onClick={() => setShowSmartFillModal(false)}><Icon d={Icons.X} /></button>
                                </div>
                                <textarea className="w-full h-32 p-3 border rounded-lg text-sm" placeholder="貼上文字..." value={smartFillText} onChange={e => setSmartFillText(e.target.value)} />
                                <div className="flex justify-end">
                                    <button onClick={handleSmartFill} disabled={isAiLoading} className="bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                        {isAiLoading ? <Icon d={Icons.Loader2} className="animate-spin" /> : <Icon d={Icons.Sparkles} />} 分析
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">
                        <header className="bg-blue-700 text-white p-4 flex items-center gap-4 sticky top-0 z-30 shadow-md">
                            <button onClick={() => setIsSidebarOpen(true)}><Icon d={Icons.Menu} size={28} /></button>
                            <h1 className="text-xl font-bold">公文發文系統</h1>
                            <div className="ml-auto text-xs bg-blue-800 px-2 py-1 rounded">{selectedOfficer}</div>
                        </header>

                        <div className="p-5 space-y-4 bg-slate-50 border-b border-slate-200">
                            <button onClick={() => setShowSmartFillModal(true)} className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-lg text-sm font-bold shadow-md flex justify-center gap-2">
                                <Icon d={Icons.Sparkles} size={16} /> AI 智慧填表 (Smart Fill)
                            </button>

                            <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                <div className="space-y-4 pl-2">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <div className="flex items-center h-6 mb-1 text-xs font-bold text-slate-500">發文日期</div>
                                            <div className="relative">
                                                <input type="date" name="date" value={formData.date} onChange={handleInputChange} className="w-full p-2 pl-8 bg-slate-50 border border-slate-300 rounded text-sm outline-none" />
                                                <span className="absolute left-2 top-2.5 text-slate-400"><Icon d={Icons.Calendar} size={14} /></span>
                                            </div>
                                        </div>
                                        <div className="space-y-1">
                                            <div className="flex justify-between items-center h-6 mb-1">
                                                <label className="text-xs font-bold text-slate-500">發文者</label>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleAddItem('author')} className="text-blue-600 bg-blue-50 rounded p-0.5"><Icon d={Icons.Plus} size={14} /></button>
                                                    <button onClick={() => handleDeleteItem('author')} className="text-red-500 bg-red-50 rounded p-0.5"><Icon d={Icons.Trash2} size={14} /></button>
                                                </div>
                                            </div>
                                            <div className="relative">
                                                <input list="authors-list" name="author" value={formData.author} onChange={handleInputChange} className="w-full p-2 pl-8 bg-slate-50 border border-slate-300 rounded text-sm outline-none" placeholder="選擇" />
                                                <span className="absolute left-2 top-2.5 text-slate-400"><Icon d={Icons.User} size={14} /></span>
                                                <datalist id="authors-list">{authorsList.map(a => <option key={a} value={a} />)}</datalist>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <div className="flex justify-between items-center h-6 mb-1">
                                                <label className="text-xs font-bold text-slate-500">文電代字</label>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleAddItem('code')} className="text-blue-600 bg-blue-50 rounded p-0.5"><Icon d={Icons.Plus} size={14} /></button>
                                                    <button onClick={() => handleDeleteItem('code')} className="text-red-500 bg-red-50 rounded p-0.5"><Icon d={Icons.Trash2} size={14} /></button>
                                                </div>
                                            </div>
                                            <div className="relative">
                                                <input list="codes-list" name="code" value={formData.code} onChange={handleInputChange} className="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none" placeholder="選擇" />
                                                <datalist id="codes-list">{codesList.map(c => <option key={c} value={c} />)}</datalist>
                                                <span className="absolute right-2 top-3 text-slate-400 pointer-events-none"><Icon d={Icons.ChevronDown} size={12} /></span>
                                            </div>
                                        </div>
                                        <div className="space-y-1">
                                            <div className="flex items-center h-6 mb-1 text-xs font-bold text-slate-500">字號 <span className="text-[10px] font-normal text-slate-400 ml-1">(自動)</span></div>
                                            <input type="text" name="number" value={formData.number} onChange={handleInputChange} className="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none" placeholder="輸入字號" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-slate-50 rounded-xl p-4 border border-slate-200 shadow-sm mt-4">
                                <div className="flex items-center gap-2 mb-3 text-blue-600">
                                    <Icon d={Icons.Briefcase} size={16} /> <span className="text-sm font-bold text-slate-700">第二層：行政類別</span>
                                </div>
                                <div className="bg-white p-1 rounded-lg border border-slate-200 flex mb-3 shadow-sm">
                                    {Object.entries(ADMIN_TYPES).map(([key, cfg]) => (
                                        <button key={key} onClick={() => { setAdminType(key); if (key === 'general') setSelectedRank(null); setAdminNumber(''); }} className={`flex-1 py-2 text-xs rounded-md flex justify-center gap-1 transition-all ${adminType === key ? 'bg-blue-50 text-blue-700 font-bold border border-blue-100' : 'text-slate-500 hover:bg-slate-50'}`}>
                                            {cfg.label}
                                        </button>
                                    ))}
                                </div>
                                {adminType !== 'general' && (
                                    <div className="bg-white p-4 rounded-lg border border-blue-100 flex flex-col gap-3 animate-fadeIn shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <span className="text-sm font-bold text-blue-700 w-12 text-right">身分:</span>
                                            <div className="flex-1 flex gap-2">
                                                {RANKS.map(r => (
                                                    <button key={r.id} onClick={() => setSelectedRank(r.id)} className={`flex-1 py-1.5 text-xs rounded border transition-colors ${selectedRank === r.id ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-slate-200 text-slate-600'}`}>{r.label}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className="text-sm font-bold text-blue-700 w-12 text-right">令號:</span>
                                            <div className="flex-1 flex items-center bg-slate-50 border border-slate-300 rounded px-3 py-1.5">
                                                <span className="text-sm font-bold text-slate-600 mr-2">{ADMIN_TYPES[adminType].prefix}</span>
                                                <input type="text" value={adminNumber} onChange={e => setAdminNumber(e.target.value)} className="flex-1 bg-transparent text-sm outline-none font-bold text-blue-800" placeholder="自動" />
                                                <span className="text-sm text-slate-500">號</span>
                                            </div>
                                        </div>
                                        {selectedRank && <div className="text-right text-[10px] text-blue-400 font-mono mt-1">預覽: {getAdminTagString()}</div>}
                                    </div>
                                )}
                            </div>

                            <div className="space-y-1">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-slate-500">主旨</label>
                                    <button onClick={handleAiRefine} disabled={isAiLoading || !formData.subject} className="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded flex items-center gap-1"><Icon d={Icons.Sparkles} size={10} /> AI 潤飾</button>
                                </div>
                                <textarea name="subject" rows="3" value={formData.subject} onChange={handleInputChange} className="w-full p-3 bg-white border border-slate-300 rounded-lg text-sm outline-none resize-none" placeholder="輸入主旨..." />
                            </div>

                            <div className="grid grid-cols-3 gap-3">
                                <button onClick={handleSearch} className="flex items-center justify-center gap-1 py-2 rounded-lg border border-blue-600 text-blue-600 text-sm font-medium hover:bg-blue-50"><Icon d={Icons.Search} size={16} /> 查詢</button>
                                <button onClick={handleUpdate} className="flex items-center justify-center gap-1 py-2 rounded-lg border text-sm font-medium bg-slate-50 hover:bg-slate-100"><Icon d={Icons.Edit} size={16} /> 更改</button>
                                <button onClick={handleRegister} className="flex items-center justify-center gap-1 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium shadow-md hover:bg-blue-700"><Icon d={Icons.Plus} size={16} /> 登錄</button>
                            </div>
                        </div>

                        <div className="flex-1 bg-slate-100 p-4 pb-20">
                             <div className="flex flex-col gap-2 mb-3">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icon d={Icons.ClipboardList} size={18} /> 發文紀錄 <span className="text-xs font-normal text-slate-400">({filteredRecords.length})</span></h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => setSortOrder(p => p === 'newest' ? 'oldest' : 'newest')} className="flex items-center gap-1 text-[11px] bg-white border border-slate-200 px-2 py-1 rounded text-slate-600 hover:bg-slate-50">{sortOrder === 'newest' ? '字號大→小' : '字號小→大'}</button>
                                        <button onClick={() => setIsListExpanded(p => !p)} className="flex items-center gap-1 text-[11px] bg-white border border-slate-200 px-2 py-1 rounded text-slate-600 hover:bg-slate-50">{isListExpanded ? '收合' : '全展開'}</button>
                                    </div>
                                </div>
                                {searchMode && <div className="text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded border border-amber-100 flex justify-between items-center"><span>搜尋: "{searchQuery}"</span><button onClick={() => { setSearchMode(false); setSearchQuery(""); }} className="underline">清除</button></div>}
                            </div>
                            
                            <div className="space-y-3">
                                {filteredRecords.map((record) => (
                                    <div key={record.id} onClick={() => { setFormData(record); if (record.adminTag) { if (record.adminTag.includes('人勤令')) setAdminType('award'); else if (record.adminTag.includes('人職令')) setAdminType('transfer'); else setAdminType('general'); if (record.adminTag.includes('(官)')) setSelectedRank('officer'); else if (record.adminTag.includes('(士)')) setSelectedRank('nco'); else if (record.adminTag.includes('(兵)')) setSelectedRank('soldier'); const match = record.adminTag.match(/\)(\d+)號/); if (match) setAdminNumber(match[1]); } else { setAdminType('general'); setSelectedRank(null); setAdminNumber(''); } window.scrollTo({ top: 0, behavior: 'smooth' }); }} className={`bg-white rounded-xl p-3 shadow-sm border hover:shadow-md relative group cursor-pointer transition-all ${formData.id === record.id ? 'ring-2 ring-amber-400 border-amber-400' : 'border-slate-200'}`}>
                                        <button onClick={(e) => { e.stopPropagation(); handleCopy(record); }} className="absolute top-2 right-2 p-1.5 text-slate-300 hover:text-blue-600 hover:bg-blue-50 rounded"><Icon d={Icons.Copy} size={16} /></button>
                                        <div className="flex flex-wrap gap-2 text-[11px] font-mono text-slate-500 mb-2 pr-8">
                                            <span className="bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">{record.date}</span>
                                            <span className="bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200 text-slate-700 font-bold">{record.code}</span>
                                            <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-100 font-bold">{record.number}</span>
                                            <span>{record.author}</span>
                                        </div>
                                        <div className={`text-sm text-slate-800 ${isListExpanded ? '' : 'line-clamp-2'} leading-relaxed`}>{record.subject}</div>
                                        {record.adminTag && <div className="mt-2 flex"><span className="bg-purple-50 text-purple-700 text-[10px] px-2 py-0.5 rounded border border-purple-100 font-bold flex items-center gap-1"><Icon d={Icons.Tag} size={10} /> {record.adminTag}</span></div>}
                                    </div>
                                ))}
                                {filteredRecords.length === 0 && <div className="text-center py-10 text-slate-400 text-xs">無符合資料</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>