<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å…¬æ–‡ç™¼æ–‡ç³»çµ± (ä¿®æ­£ç‰ˆ)</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome åœ–ç¤º -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    // ğŸ”¥ ä¿®æ­£å¾Œçš„ä¸»è¦ React App å…ƒä»¶
    const { useState, useEffect, useMemo } = React;

    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.appspot.com",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
    };

    const CURRENT_APP_ID = "dispatch-system-fixed-v2";

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function App() {
      const getInitialForm = () => ({
        id: null,
        date: new Date().toISOString().split("T")[0],
        author: "",
        code: "",
        number: "",
        subject: "",
        docType: "ä¸€èˆ¬å…¬æ–‡",
        rank: "è»å®˜",
        subNumber: ""
      });

      const [user, setUser] = useState(null);
      const [records, setRecords] = useState([]);
      const [meta, setMeta] = useState({ authors: [], codes: [], authorDefaults: {} });
      const [form, setForm] = useState(getInitialForm());
      const [filter, setFilter] = useState({ type: 'all', value: '' });
      const [processing, setProcessing] = useState(false);

      useEffect(() => {
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
          auth.onAuthStateChanged(u => {
            if (u) setUser(u);
            else auth.signInAnonymously();
          });
        });
      }, []);

      useEffect(() => {
        if (!user) return;
        const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);

        const unsubRecords = userRef.collection("records")
          .orderBy("createdAt", "desc").limit(100)
          .onSnapshot(snap => {
            setRecords(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        const unsubMeta = userRef.collection("metadata").doc("general")
          .onSnapshot(doc => {
            if (doc.exists) setMeta(doc.data());
          });

        return () => { unsubRecords(); unsubMeta(); };
      }, [user]);

      const nextNumbers = useMemo(() => {
        const today = new Date();
        const prefix = String(today.getFullYear() - 1911);
        const main = (() => {
          const nums = records.map(r => r.number).filter(n => n && n.startsWith(prefix)).map(n => parseInt(n, 10));
          return nums.length === 0 ? prefix + "0000001" : String(Math.max(...nums) + 1);
        })();
        const getSub = (type, rank) => {
          if (type === "ä¸€èˆ¬å…¬æ–‡") return "";
          const nums = records.filter(r => r.docType === type && r.rank === rank)
            .map(r => parseInt(r.subNumber, 10)).filter(n => !isNaN(n));
          return nums.length === 0 ? "001" : String(Math.max(...nums) + 1).padStart(3, "0");
        };
        return { main, getSub };
      }, [records]);

      useEffect(() => {
        if (!form.id) {
          setForm(prev => ({
            ...prev,
            number: nextNumbers.main,
            subNumber: nextNumbers.getSub(form.docType, form.rank)
          }));
        }
      }, [form.docType, form.rank, form.id, nextNumbers]);

      const handleSubmit = async (forceNew = false) => {
        if (!user) return;
        if (!form.date || !form.author || !form.code || !form.subject)
          return alert("âŒ è³‡æ–™ä¸å®Œæ•´ï¼šæ—¥æœŸã€ç™¼æ–‡è€…ã€ä»£å­—ã€ä¸»æ—¨ç‚ºå¿…å¡«");

        setProcessing(true);
        try {
          const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);
          const isNew = forceNew || !form.id;
          const payload = {
            ...form,
            id: null,
            number: isNew ? nextNumbers.main : form.number,
            subNumber: isNew ? nextNumbers.getSub(form.docType, form.rank) : form.subNumber,
            updatedAt: new Date().toISOString(),
          };
          if (isNew) {
            payload.createdAt = new Date().toISOString();
            await userRef.collection("records").add(payload);
          } else {
            await userRef.collection("records").doc(form.id).set(payload, { merge: true });
          }

          if (form.author && form.code) {
            await userRef.collection("metadata").doc("general").set({
              authors: firebase.firestore.FieldValue.arrayUnion(form.author),
              codes: firebase.firestore.FieldValue.arrayUnion(form.code)
            }, { merge: true });
          }

          const reset = getInitialForm();
          reset.date = form.date;
          reset.author = form.author;
          reset.code = form.code;
          setForm(reset);
          window.scrollTo({ top: 0, behavior: "smooth" });

        } catch (e) {
          alert("éŒ¯èª¤ï¼š" + e.message);
        } finally {
          setProcessing(false);
        }
      };

      return (
        <div className="p-4 max-w-2xl mx-auto">
          <h1 className="text-xl font-bold mb-4">å…¬æ–‡ç™¼æ–‡ç³»çµ±ï¼ˆä¿®æ­£ç‰ˆï¼‰</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="text-sm font-bold">ç™¼æ–‡æ—¥æœŸ</label>
              <input type="date" value={form.date} onChange={e => setForm({ ...form, date: e.target.value })}
                className="input-std" />
            </div>
            <div>
              <label className="text-sm font-bold">ç™¼æ–‡è€…</label>
              <input type="text" list="authorList" value={form.author} onChange={e => setForm({ ...form, author: e.target.value })}
                className="input-std" />
              <datalist id="authorList">
                {meta.authors.map(a => <option key={a} value={a} />)}
              </datalist>
            </div>
            <!-- å…¶ä»–æ¬„ä½ä¾åŸè¨­è¨ˆè£œä¸Š... -->
          </div>
          <div className="mt-4 flex gap-2">
            <button onClick={() => handleSubmit(true)} className="bg-blue-600 text-white px-4 py-2 rounded">
              <i className="fas fa-paper-plane mr-2"></i>ç™»éŒ„
            </button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
