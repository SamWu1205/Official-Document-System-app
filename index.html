<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>公文發文系統 (雲端同步+匯入版)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* iPhone 優化設置 */
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { 
      background-color: #f8fafc;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* iOS 風格輸入框 */
    .input-ios {
      height: 48px;
      width: 100%;
      font-size: 16px; 
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background-color: #fff;
      appearance: none;
      transition: all 0.2s;
    }
    .input-ios:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }
    
    .select-wrapper { position: relative; }
    .select-wrapper::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 12px;
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      pointer-events: none;
    }

    /* 側邊欄動畫 */
    .sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .sidebar-closed { transform: translateX(-100%); }
    .sidebar-open { transform: translateX(0); }
    .overlay { transition: opacity 0.3s ease; }

    @keyframes copySuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: #10b981; }
      100% { transform: scale(1); }
    }
    .animate-copy { animation: copySuccess 0.3s ease-out; }
    
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.firebasestorage.app",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
      measurementId: "G-B9R46YLGXQ",
    };
    const CURRENT_APP_ID = "dispatch-system-pro-v1";

    try {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    } catch (e) { console.error("Firebase Init Error", e); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const { useState, useEffect, useMemo, useRef } = React;

    // 日期格式化 (隱藏年份)
    const formatDateNoYear = (dateStr) => {
       if(!dateStr) return "";
       const parts = dateStr.split('-');
       if(parts.length < 3) return dateStr;
       return `${parseInt(parts[1], 10)}月${parseInt(parts[2], 10)}日`;
    };

    // --- 登入畫面組件 ---
    const LoginScreen = () => {
      const [isRegister, setIsRegister] = useState(false);
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);

      const handleAuth = async (e) => {
        e.preventDefault();
        setError("");
        setLoading(true);
        try {
          if (isRegister) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
        } catch (err) {
          console.error(err);
          let msg = "發生錯誤";
          if(err.code === 'auth/email-already-in-use') msg = "此 Email 已被註冊";
          else if(err.code === 'auth/wrong-password') msg = "密碼錯誤";
          else if(err.code === 'auth/user-not-found') msg = "找不到此帳號";
          else if(err.code === 'auth/weak-password') msg = "密碼太弱 (至少6字)";
          else if(err.code === 'auth/invalid-email') msg = "Email 格式錯誤";
          setError(msg);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
          <div className="bg-white w-full max-w-sm p-8 rounded-2xl shadow-xl fade-in">
             <div className="text-center mb-8">
               <div className="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center text-white text-3xl shadow-lg mb-4">
                 <i className="fas fa-file-signature"></i>
               </div>
               <h1 className="text-2xl font-bold text-slate-800">公文系統 Pro</h1>
               <p className="text-slate-400 text-sm mt-1">
                 {isRegister ? "建立您的雲端帳戶" : "登入以同步資料"}
               </p>
             </div>

             <form onSubmit={handleAuth} className="space-y-4">
                <div>
                  <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Email</label>
                  <input type="email" required className="input-ios" 
                    value={email} onChange={e=>setEmail(e.target.value)} placeholder="name@example.com" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">密碼</label>
                  <input type="password" required className="input-ios" 
                    value={password} onChange={e=>setPassword(e.target.value)} placeholder="••••••••" />
                </div>

                {error && <div className="text-red-500 text-sm bg-red-50 p-2 rounded-lg text-center"><i className="fas fa-exclamation-circle mr-1"></i>{error}</div>}

                <button type="submit" disabled={loading}
                  className="w-full bg-slate-900 text-white font-bold h-12 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center">
                  {loading ? <i className="fas fa-circle-notch fa-spin"></i> : (isRegister ? "註冊帳號" : "登入")}
                </button>
             </form>

             <div className="mt-6 text-center">
               <button onClick={()=>setIsRegister(!isRegister)} className="text-sm text-blue-600 font-bold hover:underline">
                 {isRegister ? "已有帳號？返回登入" : "還沒帳號？立即註冊"}
               </button>
             </div>
          </div>
        </div>
      );
    };

    function App() {
      // --- 核心狀態 ---
      const [user, setUser] = useState(null);
      const [authChecking, setAuthChecking] = useState(true); 
      
      const [records, setRecords] = useState([]);
      const [meta, setMeta] = useState({ authors: [], codes: [], authorDefaults: {} });
      const [loadingData, setLoadingData] = useState(false);
      const [processing, setProcessing] = useState(false);

      // --- 視圖控制狀態 ---
      const [menuOpen, setMenuOpen] = useState(false); 
      const [currentView, setCurrentView] = useState("home"); 
      const [docTab, setDocTab] = useState("人勤令"); 
      
      // --- 編輯狀態 ---
      const [editingDefault, setEditingDefault] = useState(null); 
      const [editingSubNumId, setEditingSubNumId] = useState(null); 
      const [editingSubNumVal, setEditingSubNumVal] = useState(""); 
      const [newAuthorName, setNewAuthorName] = useState(""); 

      // --- 檔案上傳 Ref ---
      const fileInputRef = useRef(null);

      // --- 表單狀態 ---
      const getInitialForm = () => ({
        id: null,
        date: new Date().toISOString().split("T")[0],
        author: "",
        code: "",
        number: "",      
        subject: "",
        docType: "一般公文", 
        rank: "軍官",
        subNumber: ""    
      });
      const [form, setForm] = useState(getInitialForm());
      const [isManualNumber, setIsManualNumber] = useState(false);
      const [filter, setFilter] = useState({ type: 'all', value: '' });
      const [sortOrder, setSortOrder] = useState('desc');

      // --- Auth 監聽 ---
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((u) => {
          setUser(u);
          setAuthChecking(false);
        });
        return () => unsubscribe();
      }, []);

      // --- 資料監聽 ---
      useEffect(() => {
        if (!user) {
          setRecords([]);
          return;
        }
        
        setLoadingData(true);
        const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);

        const unsubRec = userRef.collection("records")
          .orderBy("createdAt", "desc")
          .limit(300) 
          .onSnapshot(snap => {
            const data = snap.docs.map(d => {
                const docData = d.data();
                if ('id' in docData) delete docData.id; 
                return { id: d.id, ...docData };
            });
            setRecords(data);
            setLoadingData(false);
          });

        const unsubMeta = userRef.collection("metadata").doc("general")
          .onSnapshot(doc => {
            if (doc.exists) setMeta(doc.data());
            else userRef.collection("metadata").doc("general").set({ authors: [], codes: [], authorDefaults: {} });
          });

        return () => { unsubRec(); unsubMeta(); };
      }, [user]);

      // --- 自動跳號 ---
      const nextNumbers = useMemo(() => {
        const today = new Date();
        const rocYear = today.getFullYear() - 1911;
        const prefix = String(rocYear); 
        const mainNums = records
          .map(r => r.number)
          .filter(n => n && String(n).startsWith(prefix))
          .map(n => parseInt(n, 10))
          .filter(n => !Number.isNaN(n));
        const main = mainNums.length === 0 ? prefix + "0000001" : String(Math.max(...mainNums) + 1);

        const getSub = (type, rank) => {
          if (type === "一般公文") return "";
          const relevant = records.filter(r => r.docType === type && r.rank === rank && r.subNumber);
          const nums = relevant.map(r => parseInt(r.subNumber, 10)).filter(n => !Number.isNaN(n));
          return nums.length === 0 ? "001" : String(Math.max(...nums) + 1).padStart(3, '0');
        };
        return { main, getSub };
      }, [records]);

      useEffect(() => {
        if (!form.id && !isManualNumber) {
            const predictedSub = nextNumbers.getSub(form.docType, form.rank);
            setForm(prev => ({
                ...prev,
                number: nextNumbers.main,
                subNumber: predictedSub
            }));
        }
      }, [records, form.docType, form.rank, form.id, isManualNumber, nextNumbers]);

      // --- 功能函數 ---

      const handleAuthorChange = (val) => {
        let update = { author: val };
        if (meta.authorDefaults && meta.authorDefaults[val]) {
          update.code = meta.authorDefaults[val];
        }
        setForm(prev => ({ ...prev, ...update }));
      };

      const saveAuthorDefault = async (authorName, defaultCode) => {
         if (!user) return;
         try {
           const newDefaults = { ...meta.authorDefaults, [authorName]: defaultCode };
           await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid)
             .collection("metadata").doc("general")
             .update({ authorDefaults: newDefaults });
           setEditingDefault(null);
         } catch(e) { console.error(e); alert("設定失敗"); }
      };

      const handleSubmit = async (forceNew = false) => {
        if (!user) return;
        if (!form.date || !form.author || !form.code || !form.subject) return alert("資料不完整");
        
        setProcessing(true);
        try {
          const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);
          const isNew = forceNew || !form.id;
          
          const finalMain = (isNew && !isManualNumber) ? nextNumbers.main : form.number;
          const finalSub = isNew ? nextNumbers.getSub(form.docType, form.rank) : form.subNumber;
          
          const payload = {
            ...form,
            number: finalMain,
            subNumber: finalSub,
            updatedAt: new Date().toISOString()
          };
          delete payload.id; 

          if (isNew) {
            payload.createdAt = new Date().toISOString();
            await userRef.collection("records").add(payload);
          } else {
            await userRef.collection("records").doc(form.id).set(payload, { merge: true });
          }

          if (form.author && form.code) {
             await userRef.collection("metadata").doc("general").set({
               authors: firebase.firestore.FieldValue.arrayUnion(form.author),
               codes: firebase.firestore.FieldValue.arrayUnion(form.code)
             }, { merge: true });
          }

          const resetState = getInitialForm();
          resetState.date = form.date; 
          resetState.author = form.author;
          resetState.code = form.code;
          setForm(resetState);
          setFilter({type:'all', value:''});
          setIsManualNumber(false);
          window.scrollTo({top:0, behavior:'smooth'});
        } catch (e) { alert("錯誤: " + e.message); } 
        finally { setProcessing(false); }
      };

      const handleDelete = async (id) => {
        if(!id || !confirm("確定刪除?")) return;
        try {
            await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("records").doc(id).delete();
            if(form.id === id) setForm(getInitialForm());
        } catch(e) { console.error(e); alert("刪除失敗"); }
      };

      const handleExport = () => {
        if (records.length === 0) return alert("無資料");
        try {
          const exportData = records.map(r => ({
            "總號": r.number, "日期": r.date, "發文者": r.author, "代字": r.code, 
            "主旨": r.subject, "分號": r.subNumber || "", "種類": r.docType, "階級": r.rank || ""
          }));
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(exportData);
          XLSX.utils.book_append_sheet(wb, ws, "紀錄");
          XLSX.writeFile(wb, `公文備份_${new Date().toISOString().split('T')[0]}.xlsx`);
        } catch (e) { alert("匯出失敗"); }
      };

      // --- 匯入 Excel 功能 ---
      const handleImport = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if(!confirm("確定要匯入此 Excel 嗎？\n請確認這是此系統匯出的格式，以免資料錯誤。")) {
          e.target.value = null; 
          return;
        }

        setProcessing(true);
        const reader = new FileReader();
        reader.onload = async (evt) => {
          try {
            const data = evt.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            if (json.length === 0) throw new Error("Excel 內無資料");

            const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);
            const batchSize = 10; 
            let successCount = 0;
            const newAuthors = new Set();
            const newCodes = new Set();

            // 逐筆寫入 (為了安全起見不使用 batch，避免單筆錯誤導致全部失敗)
            for (let i = 0; i < json.length; i++) {
               const row = json[i];
               // 簡單的欄位對應
               const record = {
                 number: String(row["總號"] || ""),
                 date: row["日期"] || new Date().toISOString().split("T")[0],
                 author: row["發文者"] || "",
                 code: row["代字"] || "",
                 subject: row["主旨"] || "",
                 subNumber: String(row["分號"] || ""),
                 docType: row["種類"] || "一般公文",
                 rank: row["階級"] || "軍官",
                 createdAt: new Date().toISOString(),
                 updatedAt: new Date().toISOString()
               };

               if(record.number && record.subject) {
                 await userRef.collection("records").add(record);
                 successCount++;
                 if(record.author) newAuthors.add(record.author);
                 if(record.code) newCodes.add(record.code);
               }
            }

            // 更新人員與代字庫
            if (newAuthors.size > 0 || newCodes.size > 0) {
              await userRef.collection("metadata").doc("general").set({
                 authors: firebase.firestore.FieldValue.arrayUnion(...Array.from(newAuthors)),
                 codes: firebase.firestore.FieldValue.arrayUnion(...Array.from(newCodes))
              }, { merge: true });
            }

            alert(`匯入完成！成功匯入 ${successCount} 筆資料。`);
            window.location.reload(); // 重整頁面以確保資料顯示正確
          } catch (err) {
            console.error(err);
            alert("匯入失敗：" + err.message);
          } finally {
            setProcessing(false);
            e.target.value = null; // 重置 input
          }
        };
        reader.readAsBinaryString(file);
      };

      const copyToClipboard = (r) => {
         const dateText = formatDateNoYear(r.date); 
         const numSuffix = r.number ? r.number.slice(-3) : "000";
         const text = `${dateText}${r.code}${numSuffix}號：${r.subject}`;
         navigator.clipboard.writeText(text).then(() => {
             const btn = document.getElementById(`copy-btn-${r.id}`);
             if(btn) {
                 const originalHTML = btn.innerHTML;
                 btn.innerHTML = '<i class="fas fa-check text-emerald-500"></i>';
                 setTimeout(()=> btn.innerHTML = originalHTML, 1500);
             }
         });
      };

      const handleSubNumberEdit = (r) => {
        setEditingSubNumId(r.id);
        setEditingSubNumVal(r.subNumber || "");
      };

      const saveSubNumber = async () => {
        if (!editingSubNumId) return;
        try {
           await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid)
             .collection("records").doc(editingSubNumId)
             .update({ subNumber: editingSubNumVal });
           setEditingSubNumId(null);
        } catch(e) { alert("更新失敗"); }
      };

      const addAuthor = async () => {
        if(!newAuthorName.trim()) return;
        try {
          await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid)
            .collection("metadata").doc("general")
            .update({ authors: firebase.firestore.FieldValue.arrayUnion(newAuthorName.trim()) });
          setNewAuthorName("");
        } catch(e) { alert("新增失敗"); }
      };

      const deleteAuthor = async (name) => {
        if(!confirm(`確定移除 ${name} ?`)) return;
        try {
          await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid)
            .collection("metadata").doc("general")
            .update({ authors: firebase.firestore.FieldValue.arrayRemove(name) });
        } catch(e) { alert("移除失敗"); }
      };

      const handleLogout = () => {
        if(confirm("確定登出?")) auth.signOut();
      };

      const displayRecords = useMemo(() => {
        let res = [...records];
        if (filter.type === 'search') {
            const k = (filter.value || "").toLowerCase();
            res = res.filter(r => (r.subject||"").toLowerCase().includes(k) || (r.number||"").toLowerCase().includes(k));
        }
        res.sort((a, b) => {
          const numA = parseInt(a.number, 10);
          const numB = parseInt(b.number, 10);
          return sortOrder === 'desc' ? numB - numA : numA - numB;
        });
        return res;
      }, [records, filter, sortOrder]);

      const docSystemRecords = useMemo(() => {
        return records.filter(r => r.docType === docTab);
      }, [records, docTab]);

      // --- 條件渲染 ---
      if (authChecking) return <div className="h-screen flex items-center justify-center text-slate-400">載入中...</div>;
      if (!user) return <LoginScreen />;

      return (
        <div className="min-h-screen flex flex-col bg-slate-50 pb-20">
          
          {menuOpen && (
            <div 
              className="fixed inset-0 bg-black/30 z-40 backdrop-blur-sm overlay fade-in" 
              onClick={() => setMenuOpen(false)} 
            />
          )}

          {/* 左側側邊欄 */}
          <div className={`fixed inset-y-0 left-0 w-[80%] max-w-[280px] bg-white shadow-2xl z-50 sidebar flex flex-col ${menuOpen ? 'sidebar-open' : 'sidebar-closed'}`}>
            <div className="bg-slate-900 text-white p-6 pt-12">
               <h2 className="font-bold text-xl">功能選單</h2>
               <div className="text-slate-400 text-xs mt-1 truncate">{user.email}</div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-2">
               <button onClick={()=>{setCurrentView('home');setMenuOpen(false)}} 
                 className={`w-full text-left px-4 py-3 rounded-xl font-bold flex items-center gap-3 transition ${currentView==='home' ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                 <i className="fas fa-pen-nib w-6 text-center"></i> 首頁
               </button>
               
               <button onClick={()=>{setCurrentView('docs');setMenuOpen(false)}} 
                 className={`w-full text-left px-4 py-3 rounded-xl font-bold flex items-center gap-3 transition ${currentView==='docs' ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                 <i className="fas fa-folder-open w-6 text-center"></i> 公文系統
               </button>
               
               <button onClick={()=>{setCurrentView('personnel');setMenuOpen(false)}} 
                 className={`w-full text-left px-4 py-3 rounded-xl font-bold flex items-center gap-3 transition ${currentView==='personnel' ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                 <i className="fas fa-users-cog w-6 text-center"></i> 人員設定
               </button>

               <div className="border-t border-slate-100 my-2"></div>
               
               <button onClick={handleExport} className="w-full text-left px-4 py-3 rounded-xl font-bold flex items-center gap-3 text-slate-600 hover:bg-slate-50">
                  <i className="fas fa-file-export w-6 text-center"></i> 匯出 Excel
               </button>
               
               {/* 匯入 Excel 按鈕 */}
               <div className="relative">
                 <input type="file" ref={fileInputRef} onChange={handleImport} accept=".xlsx, .xls" className="hidden" />
                 <button onClick={()=>fileInputRef.current.click()} className="w-full text-left px-4 py-3 rounded-xl font-bold flex items-center gap-3 text-slate-600 hover:bg-slate-50">
                    <i className="fas fa-file-import w-6 text-center"></i> 匯入 Excel
                 </button>
               </div>
            </div>
            
            <div className="p-4 border-t border-slate-100">
               <button onClick={handleLogout} className="w-full text-left px-4 py-3 rounded-xl font-bold flex items-center gap-3 text-red-500 hover:bg-red-50 transition">
                  <i className="fas fa-sign-out-alt w-6 text-center"></i> 登出
               </button>
            </div>
          </div>

          {/* 頂部 Header */}
          <header className="sticky top-0 z-30 bg-white/90 backdrop-blur shadow-sm border-b border-slate-100 px-4 h-14 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button onClick={() => setMenuOpen(true)} className="text-slate-700 text-xl p-1 active:scale-95 transition">
                <i className="fas fa-bars"></i>
              </button>
              <h1 className="font-bold text-lg text-slate-800">
                {currentView === 'home' && '填寫表單'}
                {currentView === 'docs' && '公文系統'}
                {currentView === 'personnel' && '人員設定'}
              </h1>
            </div>
            
            {currentView === 'home' && (
              <button onClick={()=>{setForm(getInitialForm());setFilter({type:'all',value:''});setIsManualNumber(false)}} 
                className="text-slate-400 hover:text-slate-600 text-sm font-medium px-2 py-1">
                 重置
              </button>
            )}
          </header>

          {/* --- 視圖 1: 首頁 --- */}
          {currentView === 'home' && (
            <main className="flex-1 w-full max-w-md mx-auto p-4 space-y-5 fade-in">
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 space-y-4">
                 <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-1">
                      <label className="text-xs font-bold text-slate-500 ml-1">發文日期</label>
                      <div className="relative h-12">
                          <div className="absolute inset-0 flex items-center px-3 border border-slate-200 rounded-xl bg-white text-slate-800 pointer-events-none">
                             {form.date ? <span className="text-base font-bold">{formatDateNoYear(form.date)}</span> : <span className="text-slate-400">請選擇</span>}
                          </div>
                          <input type="date" className="absolute inset-0 w-full h-full opacity-0 z-10" 
                            value={form.date} onChange={e=>setForm({...form, date:e.target.value})} />
                      </div>
                    </div>
                    <div className="space-y-1">
                      <label className="text-xs font-bold text-slate-500 ml-1">發文者</label>
                      <div className="select-wrapper">
                        <input type="text" list="authList" className="input-ios" placeholder="選擇" value={form.author} onChange={e=>handleAuthorChange(e.target.value)} />
                        <datalist id="authList">{meta.authors.map(a=><option key={a} value={a}/>)}</datalist>
                      </div>
                    </div>
                 </div>

                 <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-1">
                      <label className="text-xs font-bold text-slate-500 ml-1">文電代字</label>
                      <div className="select-wrapper">
                        <input type="text" list="codeList" className="input-ios" placeholder="選擇" value={form.code} onChange={e=>setForm({...form, code:e.target.value})} />
                        <datalist id="codeList">{meta.codes.map(c=><option key={c} value={c}/>)}</datalist>
                      </div>
                    </div>
                    <div className="space-y-1">
                       <label className="text-xs font-bold text-slate-500 ml-1">總號 ({isManualNumber?"手動":"自動"})</label>
                       <div className="relative">
                           <input type="text" readOnly={!isManualNumber} value={form.number} onChange={e => setForm({...form, number: e.target.value})}
                               className={`input-ios text-center font-mono font-bold ${isManualNumber?"border-blue-400 ring-1 ring-blue-50":"bg-slate-50 text-slate-500"}`} placeholder="自動" />
                           <button onClick={() => setIsManualNumber(!isManualNumber)} className="absolute right-0 top-0 bottom-0 px-3 text-slate-400 hover:text-blue-600">
                               <i className={`fas ${isManualNumber?"fa-lock":"fa-pen"}`}></i>
                           </button>
                       </div>
                    </div>
                 </div>

                 <div className="space-y-1">
                   <label className="text-xs font-bold text-slate-500 ml-1">主旨</label>
                   <textarea rows="2" className="w-full bg-white border border-slate-200 rounded-xl px-3 py-3 text-base outline-none resize-none focus:border-blue-500 transition"
                      value={form.subject} onChange={e=>setForm({...form, subject:e.target.value})} placeholder="輸入內容..."></textarea>
                 </div>

                 <div className="pt-2 space-y-3">
                    <div className="flex gap-2 p-1 bg-slate-100 rounded-lg overflow-x-auto">
                       {['一般公文','人勤令','人職令'].map(t => (
                         <button key={t} onClick={()=>setForm({...form, docType:t})}
                           className={`flex-1 py-2 text-xs rounded-md font-bold whitespace-nowrap transition-all ${form.docType===t?'bg-white text-blue-600 shadow-sm':'text-slate-400'}`}>
                           {t}
                         </button>
                       ))}
                    </div>
                    {form.docType !== '一般公文' && (
                      <div className="flex gap-2 p-1 bg-slate-100 rounded-lg animate-copy">
                         {['軍官','士官','士兵'].map(r => (
                           <button key={r} onClick={()=>setForm({...form, rank:r})}
                             className={`flex-1 py-2 text-xs rounded-md font-bold ${form.rank===r?'bg-indigo-600 text-white shadow-sm':'text-slate-400'}`}>{r}</button>
                         ))}
                      </div>
                    )}
                 </div>

                 <div className="grid grid-cols-4 gap-2 pt-2">
                    <button onClick={()=>{
                        const k = prompt("輸入關鍵字查詢");
                        if(k) setFilter({type:'search', value:k});
                    }} className="col-span-1 h-12 rounded-xl border border-slate-300 text-slate-600 font-bold bg-white">查詢</button>
                    
                    <button onClick={()=>{setIsManualNumber(true);handleSubmit(false)}} disabled={!form.id} 
                      className={`col-span-1 h-12 rounded-xl border font-bold ${form.id?'bg-blue-50 text-blue-600 border-blue-200':'bg-slate-50 text-slate-300'}`}>修改</button>
                    
                    <button onClick={()=>handleSubmit(true)} disabled={processing}
                      className="col-span-2 h-12 rounded-xl bg-slate-900 text-white font-bold shadow-lg flex justify-center items-center">
                      {processing ? <i className="fas fa-circle-notch fa-spin"></i> : "登錄"}
                    </button>
                 </div>
              </div>

              <div className="space-y-4">
                 <h2 className="font-bold text-slate-800 text-lg px-2">
                    {filter.type==='search' ? `搜尋: ${filter.value}` : '最近紀錄'}
                    {filter.type==='search' && <button onClick={()=>setFilter({type:'all'})} className="ml-2 text-xs text-blue-500">清除</button>}
                 </h2>
                 {loadingData && <div className="text-center text-slate-400 py-4">讀取資料中...</div>}
                 {!loadingData && displayRecords.slice(0, 20).map(r => (
                   <div key={r.id} onClick={()=>{setForm({...r}); setIsManualNumber(true); window.scrollTo({top:0,behavior:'smooth'})}}
                      className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm active:bg-slate-50 transition relative overflow-hidden group">
                      <div className="flex justify-between items-start mb-1">
                         <span className="font-mono font-bold text-blue-600 text-lg">#{r.number}</span>
                         <div className="text-xs text-slate-400">{formatDateNoYear(r.date)}</div>
                      </div>
                      <div className="text-base font-bold text-slate-800 mb-2 line-clamp-1">{r.subject}</div>
                      <div className="flex items-center gap-2 text-xs text-slate-500">
                          <span className="bg-slate-100 px-2 py-1 rounded">{r.author}</span>
                          {r.docType!=='一般公文' && <span className="bg-indigo-50 text-indigo-600 px-2 py-1 rounded">{r.docType} {r.subNumber}</span>}
                          
                          <div className="ml-auto flex gap-2">
                              <button onClick={(e)=>{e.stopPropagation();copyToClipboard(r)}} id={`copy-btn-${r.id}`} className="w-8 h-8 flex items-center justify-center bg-emerald-50 text-emerald-600 rounded border border-emerald-100">
                                <i className="fas fa-copy"></i>
                              </button>
                              <button onClick={(e)=>{e.stopPropagation();handleDelete(r.id)}} className="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded border border-red-100">
                                <i className="fas fa-trash-alt"></i>
                              </button>
                          </div>
                      </div>
                   </div>
                 ))}
                 {!loadingData && displayRecords.length === 0 && <div className="text-center text-slate-400 py-8">尚無資料</div>}
              </div>
            </main>
          )}

          {/* --- 視圖 2: 公文系統 --- */}
          {currentView === 'docs' && (
            <main className="flex-1 w-full max-w-md mx-auto p-4 space-y-4 fade-in">
               <div className="flex bg-slate-200 p-1 rounded-xl">
                  <button onClick={()=>setDocTab('人勤令')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${docTab==='人勤令'?'bg-white text-blue-600 shadow-sm':'text-slate-500'}`}>人勤令</button>
                  <button onClick={()=>setDocTab('人職令')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${docTab==='人職令'?'bg-white text-blue-600 shadow-sm':'text-slate-500'}`}>人職令</button>
               </div>

               <div className="space-y-3">
                  {docSystemRecords.length === 0 ? <div className="text-center text-slate-400 py-10">尚無資料</div> : docSystemRecords.map(r => (
                    <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                       <div className="flex justify-between items-start">
                          <div>
                             <div className="text-xs text-slate-400 mb-1">{formatDateNoYear(r.date)}</div>
                             <h3 className="font-bold text-slate-800 text-lg mb-1">{r.subject}</h3>
                             <div className="text-sm text-slate-600 bg-slate-100 inline-block px-2 py-0.5 rounded">{r.author} ({r.rank})</div>
                          </div>
                          
                          <div className="text-right pl-2">
                             <div className="text-[10px] text-slate-400 mb-1">分號</div>
                             {editingSubNumId === r.id ? (
                               <div className="flex items-center gap-1">
                                  <input type="text" className="w-16 border border-blue-500 rounded px-1 py-0.5 text-center font-mono text-lg" 
                                    value={editingSubNumVal} onChange={e=>setEditingSubNumVal(e.target.value)} autoFocus />
                                  <div className="flex flex-col gap-1">
                                    <button onClick={saveSubNumber} className="w-6 h-6 bg-green-500 text-white rounded flex items-center justify-center"><i className="fas fa-check text-xs"></i></button>
                                    <button onClick={()=>setEditingSubNumId(null)} className="w-6 h-6 bg-gray-300 text-white rounded flex items-center justify-center"><i className="fas fa-times text-xs"></i></button>
                                  </div>
                               </div>
                             ) : (
                               <div className="group cursor-pointer" onClick={()=>handleSubNumberEdit(r)}>
                                  <span className="font-mono font-bold text-blue-900 text-2xl border-b border-transparent group-hover:border-blue-300 transition-all">{r.subNumber}</span>
                                  <div className="text-[10px] text-blue-400 opacity-0 group-hover:opacity-100">點擊修改</div>
                               </div>
                             )}
                          </div>
                       </div>
                    </div>
                  ))}
               </div>
            </main>
          )}

          {/* --- 視圖 3: 人員設定 --- */}
          {currentView === 'personnel' && (
            <main className="flex-1 w-full max-w-md mx-auto p-4 fade-in">
               <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                  <div className="p-4 border-b border-slate-100 bg-slate-50">
                     <h2 className="font-bold text-slate-700 mb-3">新增人員</h2>
                     <div className="flex gap-2">
                        <input type="text" value={newAuthorName} onChange={e=>setNewAuthorName(e.target.value)} 
                          placeholder="輸入姓名..." className="flex-1 px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500" />
                        <button onClick={addAuthor} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95">新增</button>
                     </div>
                  </div>
                  <div className="divide-y divide-slate-100">
                     {meta.authors.map(a => (
                       <div key={a} className="p-4 flex justify-between items-center hover:bg-slate-50 transition">
                          <div>
                             <div className="font-bold text-slate-800 text-lg">{a}</div>
                             <div className="text-xs text-slate-400 mt-1 flex items-center gap-1 cursor-pointer" onClick={()=>setEditingDefault(a)}>
                                <i className="fas fa-link"></i>
                                {editingDefault === a ? (
                                   <select className="bg-white border border-slate-300 rounded" 
                                      value={meta.authorDefaults?.[a]||""} 
                                      onChange={(e)=>saveAuthorDefault(a, e.target.value)} onBlur={()=>setEditingDefault(null)} autoFocus>
                                      <option value="">無預設</option>
                                      {meta.codes.map(c=><option key={c} value={c}>{c}</option>)}
                                   </select>
                                ) : (
                                   <span>預設: {meta.authorDefaults?.[a] || "未設定"}</span>
                                )}
                             </div>
                          </div>
                          <button onClick={()=>deleteAuthor(a)} className="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-red-500 rounded-full hover:bg-red-50 transition">
                             <i className="fas fa-trash-alt"></i>
                          </button>
                       </div>
                     ))}
                     {meta.authors.length === 0 && <div className="p-8 text-center text-slate-400">尚無人員資料</div>}
                  </div>
               </div>
            </main>
          )}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
