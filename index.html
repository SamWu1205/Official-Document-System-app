<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>æ¥­å‹™ç®¡ç†ç³»çµ±</title>
  <link rel="icon" href="./logo.jpg" />
  <link rel="apple-touch-icon" href="./logo.jpg" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { background-color: #f8fafc; font-family: sans-serif; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); overscroll-behavior-y: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .input-ios { height: 48px; width: 100%; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; padding: 0 12px; }
    .sidebar { transition: transform 0.3s; } .sidebar-closed { transform: translateX(-100%); } .sidebar-open { transform: translateX(0); }
    .bg-dot-pattern { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
    @keyframes bellShake { 0% { transform: rotate(0); } 15% { transform: rotate(15deg); } 30% { transform: rotate(-15deg); } 45% { transform: rotate(10deg); } 60% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 85% { transform: rotate(-5deg); } 100% { transform: rotate(0); } }
    .animate-bell { animation: bellShake 1s infinite; }
    .card-transition { transition: transform 0.1s; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.firebasestorage.app",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
      measurementId: "G-B9R46YLGXQ"
    };
    const APP_ID = "dispatch-system-pro-v1";

    try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const { useState, useEffect, useMemo, useRef } = React;

    // Helper Functions
    const formatDate = (d) => { if(!d) return ""; const p=d.split('-'); return p.length<3?d:`${parseInt(p[1])}æœˆ${parseInt(p[2])}æ—¥`; };
    const formatTime = (iso) => { if(!iso) return ""; const d=new Date(iso); return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };
    const getNowISO = () => { const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); };
    
    // å£“ç¸®åœ–ç‰‡
    const compressImg = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                let w=img.width, h=img.height;
                if(w>800){ h=(800/w)*h; w=800; }
                cvs.width=w; cvs.height=h;
                cvs.getContext('2d').drawImage(img,0,0,w,h);
                resolve(cvs.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });

    // --- Task Card Component ---
    const TaskCard = ({ t, onClick, onDone, onDel, onDragStart, onDragOver, onDrop }) => {
        const [sx, setSx] = useState(0);
        const startX = useRef(null);
        
        // æé†’é‚è¼¯
        const now = new Date();
        const end = new Date(t.endDate);
        const diff = end - now; // æ¯«ç§’å·®
        const diffDays = Math.floor(diff/86400000);
        const isExpired = diff < 0;
        
        // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºéˆ´éºï¼š(æœ‰è¨­å®šæé†’ ä¸” æ™‚é–“åˆ°äº†) æˆ– (å·²éæœŸ)
        const remindMs = parseInt(t.reminderMinutes||0)*60000;
        const showBell = (remindMs>0 && diff>0 && diff<=remindMs) || isExpired;
        
        // å‰©é¤˜æ–‡å­—
        let remainTxt = "";
        if(isExpired) remainTxt = "å·²éæœŸ";
        else if(diffDays>0) remainTxt = `å‰©${diffDays}å¤©`;
        else {
            const hrs = Math.floor(diff/3600000);
            const mins = Math.floor((diff%3600000)/60000);
            remainTxt = `å‰©${hrs}æ™‚${mins}åˆ†`;
        }

        const isDone = t.status==='completed';
        const color = t.priority==='æ€¥ä»¶'?'bg-red-500':t.priority==='ä¸€èˆ¬'?'bg-emerald-500':'bg-purple-500';

        // æ»‘å‹•é‚è¼¯
        const tStart = (e) => { if(!isDone) startX.current = e.touches[0].clientX; };
        const tMove = (e) => {
            if(!startX.current || isDone) return;
            const d = e.touches[0].clientX - startX.current;
            if(d < 0 && d > -100) setSx(d);
        };
        const tEnd = () => {
            if(sx < -60 && confirm("è¾¦çµæ­¤å·¥ä½œï¼Ÿ")) onDone(t.id);
            setSx(0); startX.current=null;
        };

        return (
            <div className={`relative mb-3 rounded-2xl overflow-hidden shadow-sm border border-slate-100 ${isDone?'opacity-50 grayscale bg-slate-50':'bg-white'}`}
                 draggable={!isDone} onDragStart={onDragStart} onDragOver={onDragOver} onDrop={onDrop}>
                <div className="absolute inset-0 bg-blue-500 flex items-center justify-end pr-6"><span className="text-white font-bold"><i className="fas fa-check"></i> è¾¦çµ</span></div>
                <div className="relative bg-white p-4 card-transition" style={{transform:`translateX(${sx}px)`}}
                     onTouchStart={tStart} onTouchMove={tMove} onTouchEnd={tEnd} onClick={onClick}>
                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${color}`}></div>
                    <div className="flex justify-between items-start pl-3">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                                <h3 className={`font-bold text-lg ${isDone?'line-through text-slate-400':'text-slate-800'}`}>{t.title}</h3>
                                {t.imageUrl && <i className="fas fa-image text-slate-400"></i>}
                            </div>
                            <div className="text-xs text-slate-500">
                                <div>å§”è¨—ï¼š{t.delegator||"ç„¡"} | {t.type}</div>
                                <div><i className="far fa-clock"></i> {formatTime(t.startDate)} â†’ {formatTime(t.endDate)}</div>
                            </div>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                            {!isDone && (
                                <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded ${isExpired?'bg-red-100 text-red-600':showBell?'bg-red-50 text-red-600':'bg-slate-100 text-slate-600'}`}>
                                    {showBell && <i className="fas fa-bell animate-bell text-red-500"></i>}
                                    {remainTxt}
                                </div>
                            )}
                            {isDone && <span className="text-xs font-bold bg-slate-200 text-slate-500 px-2 py-1 rounded">å·²è¾¦çµ</span>}
                            <div className="flex gap-2 mt-1">
                                {!isDone && <button onClick={(e)=>{e.stopPropagation();onDone(t.id)}} className="w-8 h-8 rounded-full bg-blue-50 text-blue-500"><i className="fas fa-check"></i></button>}
                                <button onClick={(e)=>{e.stopPropagation();onDel(t.id)}} className="w-8 h-8 rounded-full bg-slate-100 text-slate-400"><i className="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- Main App ---
    function App() {
      const [user, setUser] = useState(null);
      const [view, setView] = useState("home"); // home, docs, tasks, settings
      const [menu, setMenu] = useState(false);
      
      // Data
      const [recs, setRecs] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [meta, setMeta] = useState({authors:[], codes:[], taskTypes:[]});
      
      // Forms
      const [form, setForm] = useState({id:null, date:getNowISO().split('T')[0], author:"", code:"", number:"", subject:"", docType:"ä¸€èˆ¬å…¬æ–‡", rank:"è»å®˜", subNumber:""});
      const [isManual, setIsManual] = useState(false);
      const [taskForm, setTaskForm] = useState({id:null, title:"", type:"è¡Œæ”¿", delegator:"", priority:"ä¸€èˆ¬", startDate:getNowISO(), endDate:getNowISO(), notes:"", reminderMinutes:"0", imageUrl:""});
      const [showTask, setShowTask] = useState(false);
      const [filter, setFilter] = useState("");
      const [taskTab, setTaskTab] = useState("å…¨éƒ¨");

      // Refs
      const dragItem = useRef();
      const dragOverItem = useRef();
      const fileRef = useRef();
      const imgRef = useRef();

      useEffect(() => { auth.onAuthStateChanged(u => setUser(u)); }, []);

      useEffect(() => {
        if(!user) return;
        const uRef = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid);
        
        // Load Records
        uRef.collection("records").orderBy("createdAt","desc").limit(100).onSnapshot(s => setRecs(s.docs.map(d=>({id:d.id, ...d.data()}))));
        
        // Load Tasks (å‰ç«¯æ’åº)
        uRef.collection("tasks").orderBy("createdAt","desc").onSnapshot(s => setTasks(s.docs.map(d=>({id:d.id, ...d.data()}))));
        
        // Load Meta
        uRef.collection("metadata").doc("general").onSnapshot(d => {
            if(d.exists) setMeta({...d.data(), taskTypes: d.data().taskTypes||['è¡Œæ”¿','è¨“ç·´','å¾Œå‹¤','äººäº‹','ä¿é¤Š','äº¤è¾¦','å…¶ä»–']});
            else uRef.collection("metadata").doc("general").set({authors:[], codes:[], taskTypes:['è¡Œæ”¿','è¨“ç·´','å¾Œå‹¤']});
        });
      }, [user]);

      // --- Logic: Public Docs ---
      const autoNum = useMemo(() => {
          const yr = String(new Date().getFullYear()-1911);
          const nums = recs.map(r=>r.number).filter(n=>n&&n.startsWith(yr)).map(n=>parseInt(n)).filter(n=>!isNaN(n));
          const main = nums.length? String(Math.max(...nums)+1) : yr+"0000001";
          return main;
      }, [recs]);

      useEffect(() => { if(!form.id && !isManual) setForm(p=>({...p, number:autoNum})); }, [recs, form.id, isManual, autoNum]);

      const saveRec = async () => {
          if(!form.subject) return alert("è«‹è¼¸å…¥ä¸»æ—¨");
          const uRef = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid);
          const pl = {...form, updatedAt: new Date().toISOString()};
          delete pl.id;
          if(!form.id) { pl.createdAt = new Date().toISOString(); await uRef.collection("records").add(pl); }
          else await uRef.collection("records").doc(form.id).update(pl);
          
          if(form.author) uRef.collection("metadata").doc("general").update({authors: firebase.firestore.FieldValue.arrayUnion(form.author)});
          setForm({id:null, date:form.date, author:form.author, code:form.code, number:"", subject:"", docType:"ä¸€èˆ¬å…¬æ–‡", rank:"è»å®˜", subNumber:""});
          setIsManual(false);
      };

      // --- Logic: Tasks ---
      const saveTask = async () => {
          if(!taskForm.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
          const uRef = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks");
          const pl = {...taskForm, updatedAt: new Date().toISOString()};
          delete pl.id;
          if(!taskForm.id) { pl.createdAt = new Date().toISOString(); pl.status="active"; pl.order=Date.now(); await uRef.add(pl); }
          else await uRef.doc(taskForm.id).update(pl);
          setShowTask(false);
      };

      const handleDrop = async () => {
          if(!dragItem.current || !dragOverItem.current) return;
          const cp = [...filTasks];
          const item = cp.splice(dragItem.current, 1)[0];
          cp.splice(dragOverItem.current, 0, item);
          
          const batch = db.batch();
          const uRef = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks");
          cp.forEach((t, i) => { if(t.id) batch.update(uRef.doc(t.id), {order: i}); });
          await batch.commit();
          dragItem.current=null; dragOverItem.current=null;
      };

      const filTasks = useMemo(() => {
          let res = [...tasks];
          if(taskTab!=="å…¨éƒ¨") res = res.filter(t=>t.priority===taskTab);
          if(filter) res = res.filter(t=>t.title.includes(filter));
          res.sort((a,b) => {
              if(a.status==='completed' && b.status!=='completed') return 1;
              if(a.status!=='completed' && b.status==='completed') return -1;
              return (a.order||0) - (b.order||0);
          });
          return res;
      }, [tasks, taskTab, filter]);

      // --- Login View ---
      if (!user) return (
        <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                <div className="mb-6"><img src="./logo.jpg" className="w-20 h-20 mx-auto rounded-2xl shadow border"/></div>
                <h1 className="text-2xl font-bold mb-6">æ¥­å‹™ç®¡ç†ç³»çµ±</h1>
                <button onClick={()=>auth.signInAnonymously()} className="w-full bg-gray-800 text-white h-12 rounded-xl font-bold mb-3">è¨ªå®¢è©¦ç”¨</button>
                <div className="text-sm text-gray-400">æˆ–è¼¸å…¥ Email ç™»å…¥ (éœ€å…ˆåœ¨å¾Œå°é–‹å•Ÿ)</div>
                <form onSubmit={e=>{e.preventDefault(); auth.signInWithEmailAndPassword(e.target[0].value, e.target[1].value).catch(err=>alert(err.message))}} className="mt-4 space-y-3">
                    <input type="email" placeholder="Email" className="input-ios" required/>
                    <input type="password" placeholder="å¯†ç¢¼" className="input-ios" required/>
                    <button className="w-full bg-blue-600 text-white h-12 rounded-xl font-bold">ç™»å…¥ / è¨»å†Š</button>
                </form>
                <div className="mt-4 text-xs text-blue-500 cursor-pointer" onClick={e=>{const f=e.target.closest('div').previousSibling; auth.createUserWithEmailAndPassword(f[0].value, f[1].value).catch(alert)}}>æ²’å¸³è™Ÿ? é»æ­¤è¨»å†Š</div>
            </div>
        </div>
      );

      return (
        <div className="min-h-screen flex flex-col bg-dot-pattern">
            {/* é®ç½© */}
            {menu && <div className="fixed inset-0 bg-black/30 z-40" onClick={()=>setMenu(false)}/>}
            
            {/* å´é‚Šæ¬„ */}
            <div className={`fixed inset-y-0 left-0 w-[260px] bg-white shadow-2xl z-50 sidebar ${menu?'sidebar-open':'sidebar-closed'} flex flex-col`}>
                <div className="bg-slate-900 text-white p-6 pt-10"><h2 className="text-xl font-bold">é¸å–®</h2><p className="text-xs opacity-50">{user.email||"è¨ªå®¢"}</p></div>
                <div className="flex-1 p-4 space-y-2">
                    {[
                        {k:'home',n:'å¡«å¯«è¡¨å–®',i:'pen'},
                        {k:'docs',n:'å…¬æ–‡ç³»çµ±',i:'folder'},
                        {k:'tasks',n:'å·¥ä½œç®¡åˆ¶',i:'list-check'},
                        {k:'settings',n:'ç³»çµ±è¨­å®š',i:'cog'}
                    ].map(x=>(
                        <button key={x.k} onClick={()=>{setView(x.k);setMenu(false)}} className={`w-full text-left p-3 rounded-xl font-bold flex gap-3 ${view===x.k?'bg-blue-50 text-blue-600':'text-gray-600'}`}>
                            <i className={`fas fa-${x.i} w-6 text-center`}></i> {x.n}
                        </button>
                    ))}
                    <hr className="my-2"/>
                    <button onClick={()=>auth.signOut()} className="w-full text-left p-3 text-red-500 font-bold"><i className="fas fa-sign-out-alt mr-3"></i> ç™»å‡º</button>
                </div>
            </div>

            {/* Header */}
            <header className="sticky top-0 bg-white/90 backdrop-blur border-b h-14 flex items-center px-4 justify-between z-30">
                <div className="flex items-center gap-3">
                    <button onClick={()=>setMenu(true)}><i className="fas fa-bars text-xl text-gray-700"></i></button>
                    <h1 className="font-bold text-lg">{view==='home'?'è¡¨å–®':view==='docs'?'å…¬æ–‡':view==='tasks'?'å·¥ä½œ':'è¨­å®š'}</h1>
                </div>
                {view==='home' && <button onClick={()=>setForm({id:null, date:getNowISO().split('T')[0], author:form.author, code:form.code, number:"", subject:"", docType:"ä¸€èˆ¬å…¬æ–‡", rank:"è»å®˜", subNumber:""})} className="text-sm text-gray-500">é‡ç½®</button>}
            </header>

            {/* Content */}
            <main className="flex-1 p-4 max-w-md mx-auto w-full pb-20">
                
                {/* 1. è¡¨å–® */}
                {view==='home' && (
                    <div className="space-y-4 fade-in">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border space-y-3">
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input type="date" className="input-ios" value={form.date} onChange={e=>setForm({...form,date:e.target.value})}/></div>
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500">ç™¼æ–‡è€…</label><input list="auths" className="input-ios" value={form.author} onChange={e=>setForm({...form,author:e.target.value})} placeholder="é¸æ“‡"/><datalist id="auths">{meta.authors.map(a=><option key={a} value={a}/>)}</datalist></div>
                            </div>
                            <div className="flex gap-2">
                                <div className="w-1/3"><label className="text-xs font-bold text-gray-500">ä»£å­—</label><input list="codes" className="input-ios" value={form.code} onChange={e=>setForm({...form,code:e.target.value})}/><datalist id="codes">{meta.codes.map(c=><option key={c} value={c}/>)}</datalist></div>
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500">ç¸½è™Ÿ ({isManual?'æ‰‹':'è‡ª'})</label><div className="relative"><input type="text" className="input-ios text-right pr-8" readOnly={!isManual} value={form.number} onChange={e=>setForm({...form,number:e.target.value})}/><i onClick={()=>setIsManual(!isManual)} className={`fas fa-lock${isManual?'-open':''} absolute right-3 top-3 text-gray-400`}></i></div></div>
                            </div>
                            <div><label className="text-xs font-bold text-gray-500">ä¸»æ—¨</label><textarea className="w-full border rounded-xl p-3 h-20" value={form.subject} onChange={e=>setForm({...form,subject:e.target.value})}></textarea></div>
                            <button onClick={saveRec} className="w-full bg-slate-900 text-white h-12 rounded-xl font-bold shadow">ç™»éŒ„å…¬æ–‡</button>
                        </div>
                        <div className="space-y-3">
                            <h3 className="font-bold text-gray-700">æœ€è¿‘ç´€éŒ„</h3>
                            {recs.slice(0,10).map(r=>(
                                <div key={r.id} onClick={()=>setForm({...r})} className="bg-white p-3 rounded-xl border shadow-sm">
                                    <div className="flex justify-between font-mono font-bold text-blue-600"><span>#{r.number}</span> <span className="text-xs text-gray-400 font-sans">{formatDate(r.date)}</span></div>
                                    <div className="text-sm font-bold my-1">{r.subject}</div>
                                    <div className="text-xs bg-gray-100 inline-block px-2 py-1 rounded">{r.author}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* 2. å·¥ä½œç®¡åˆ¶ */}
                {view==='tasks' && (
                    <div className="space-y-4 fade-in">
                        <div className="bg-white p-2 rounded-xl shadow-sm flex gap-2 overflow-x-auto no-scrollbar">
                            {['å…¨éƒ¨','æ€¥ä»¶','ä¸€èˆ¬','äº¤è¾¦'].map(t=><button key={t} onClick={()=>setTaskTab(t)} className={`px-4 py-1 rounded-lg text-sm font-bold whitespace-nowrap ${taskTab===t?'bg-slate-800 text-white':'bg-gray-100 text-gray-500'}`}>{t}</button>)}
                        </div>
                        <input type="text" placeholder="æœå°‹..." className="input-ios" value={filter} onChange={e=>setFilter(e.target.value)}/>
                        
                        <div className="space-y-3">
                            {filTasks.map((t,i)=>(
                                <TaskCard key={t.id} t={t} 
                                    onClick={()=>{setTaskForm(t);setShowTask(true)}}
                                    onDone={(id)=>db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks").doc(id).update({status:'completed'})}
                                    onDel={(id)=>confirm("åˆªé™¤?")&&db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks").doc(id).delete()}
                                    onDragStart={()=>dragItem.current=i} onDragOver={(e)=>{e.preventDefault();dragOverItem.current=i}} onDrop={handleDrop}
                                />
                            ))}
                            {filTasks.length===0 && <div className="text-center text-gray-400 py-10">ç„¡å·¥ä½œ</div>}
                        </div>
                        <button onClick={()=>{setTaskForm({id:null, title:"", type:"è¡Œæ”¿", delegator:"", priority:"ä¸€èˆ¬", startDate:getNowISO(), endDate:getNowISO(), notes:"", reminderMinutes:"0", imageUrl:""});setShowTask(true)}} className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl text-2xl flex items-center justify-center"><i className="fas fa-plus"></i></button>
                    </div>
                )}

                {/* 3. ç³»çµ±è¨­å®š (ç°¡æ˜“ç‰ˆ) */}
                {view==='settings' && (
                    <div className="bg-white p-4 rounded-2xl shadow-sm fade-in">
                        <h2 className="font-bold mb-4">äººå“¡ç®¡ç†</h2>
                        <div className="flex gap-2 mb-4"><input id="newAuth" className="input-ios" placeholder="å§“å"/><button onClick={()=>{const v=document.getElementById('newAuth').value; if(v) db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general").update({authors:firebase.firestore.FieldValue.arrayUnion(v)})}} className="bg-blue-600 text-white px-4 rounded-xl">æ–°å¢</button></div>
                        <div className="flex flex-wrap gap-2">{meta.authors.map(a=><span key={a} className="bg-gray-100 px-3 py-1 rounded-lg text-sm">{a} <i onClick={()=>confirm("åˆªé™¤?")&&db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general").update({authors:firebase.firestore.FieldValue.arrayRemove(a)})} className="fas fa-times ml-2 text-gray-400 cursor-pointer"></i></span>)}</div>
                    </div>
                )}

                {/* å…¬æ–‡ç³»çµ± (ç°¡æ˜“åˆ—è¡¨) */}
                {view==='docs' && <div className="text-center text-gray-400 mt-10">è«‹è‡³é¦–é è¡¨å–®æˆ–åŒ¯å‡º Excel æŸ¥çœ‹è©³ç´°å…¬æ–‡</div>}

            </main>

            {/* Task Modal */}
            {showTask && (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50" onClick={()=>setShowTask(false)}>
                    <div className="bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl space-y-4" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center"><h2 className="text-xl font-bold">{taskForm.id?"ç·¨è¼¯":"æ–°å¢"}</h2><i onClick={()=>setShowTask(false)} className="fas fa-times text-xl p-2"></i></div>
                        <div><label className="text-xs font-bold text-gray-500">æ¨™é¡Œ</label><input className="input-ios" value={taskForm.title} onChange={e=>setTaskForm({...taskForm,title:e.target.value})}/></div>
                        <div className="flex gap-2">
                            <div className="flex-1"><label className="text-xs font-bold text-gray-500">ç¨®é¡</label><select className="input-ios" value={taskForm.type} onChange={e=>setTaskForm({...taskForm,type:e.target.value})}>{meta.taskTypes.map(t=><option key={t} value={t}>{t}</option>)}</select></div>
                            <div className="flex-1"><label className="text-xs font-bold text-gray-500">é‡è¦</label><select className="input-ios" value={taskForm.priority} onChange={e=>setTaskForm({...taskForm,priority:e.target.value})}><option value="æ€¥ä»¶">ğŸ”´ æ€¥ä»¶</option><option value="ä¸€èˆ¬">ğŸŸ¢ ä¸€èˆ¬</option><option value="äº¤è¾¦">ğŸŸ£ äº¤è¾¦</option></select></div>
                        </div>
                        <div className="flex gap-2">
                            <div className="flex-1"><label className="text-xs font-bold text-gray-500">é–‹å§‹</label><input type="datetime-local" className="input-ios text-xs" value={taskForm.startDate} onChange={e=>setTaskForm({...taskForm,startDate:e.target.value})}/></div>
                            <div className="flex-1"><label className="text-xs font-bold text-gray-500">çµæŸ</label><input type="datetime-local" className="input-ios text-xs" value={taskForm.endDate} onChange={e=>setTaskForm({...taskForm,endDate:e.target.value})}/></div>
                        </div>
                        <div><label className="text-xs font-bold text-gray-500">æé†’</label><select className="input-ios" value={taskForm.reminderMinutes} onChange={e=>setTaskForm({...taskForm,reminderMinutes:e.target.value})}><option value="0">ä¸æé†’</option><option value="30">30åˆ†å‰</option><option value="60">1å°æ™‚å‰</option><option value="1440">1å¤©å‰</option></select></div>
                        <div className="relative">
                            <label className="text-xs font-bold text-gray-500">å‚™è¨» / åœ–ç‰‡</label>
                            <textarea className="w-full border rounded-xl p-3 h-24" value={taskForm.notes} onChange={e=>setTaskForm({...taskForm,notes:e.target.value})}></textarea>
                            <div className="absolute bottom-2 right-2"><input type="file" ref={fileRef} className="hidden" accept="image/*" onChange={async e=>{if(e.target.files[0]){const b64=await compressImg(e.target.files[0]);setTaskForm({...taskForm,imageUrl:b64})}}} /><button onClick={()=>fileRef.current.click()} className="w-8 h-8 bg-gray-200 rounded-full"><i className="fas fa-camera"></i></button></div>
                        </div>
                        {taskForm.imageUrl && <div className="relative"><img src={taskForm.imageUrl} className="h-32 rounded-xl object-cover"/><i onClick={()=>setTaskForm({...taskForm,imageUrl:""})} className="fas fa-times absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center"></i></div>}
                        <button onClick={saveTask} className="w-full bg-blue-600 text-white h-12 rounded-xl font-bold">å„²å­˜</button>
                    </div>
                </div>
            )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
