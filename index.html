<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>公文發文系統 (修復版)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 核心 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* iPhone 優化設置 */
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { 
      background-color: #f8fafc; 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* 滑動選單 */
    .sidebar { transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1); }
    .sidebar-closed { transform: translateX(-100%); }
    .sidebar-open { transform: translateX(0); }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* iOS 風格輸入框 */
    .input-ios {
      height: 48px;
      width: 100%;
      font-size: 16px; 
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background-color: #fff;
      appearance: none;
    }
    .input-ios:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }
    
    .select-wrapper { position: relative; }
    .select-wrapper::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 12px;
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      pointer-events: none;
    }

    @keyframes copySuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: #10b981; }
      100% { transform: scale(1); }
    }
    .animate-copy { animation: copySuccess 0.3s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.firebasestorage.app",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
      measurementId: "G-B9R46YLGXQ",
    };

    const CURRENT_APP_ID = "dispatch-system-pro-v1";

    try {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    } catch (e) { console.error("Firebase Init Error", e); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const { useState, useEffect, useMemo } = React;

    const formatDateZh = (dateStr) => {
       if(!dateStr) return "";
       const d = new Date(dateStr);
       return `${d.getMonth() + 1}月${d.getDate()}日`;
    };

    function App() {
      const [user, setUser] = useState(null);
      const [records, setRecords] = useState([]);
      const [meta, setMeta] = useState({ authors: [], codes: [], authorDefaults: {} });
      const [loading, setLoading] = useState(true);
      
      const [menuOpen, setMenuOpen] = useState(false);
      const [processing, setProcessing] = useState(false);
      const [filter, setFilter] = useState({ type: 'all', value: '' });
      const [sortOrder, setSortOrder] = useState('desc');
      const [editingDefault, setEditingDefault] = useState(null);

      const getInitialForm = () => ({
        id: null,
        date: new Date().toISOString().split("T")[0],
        author: "",
        code: "",
        number: "",      
        subject: "",
        docType: "一般公文", 
        rank: "軍官",
        subNumber: ""    
      });
      const [form, setForm] = useState(getInitialForm());

      useEffect(() => {
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
            auth.onAuthStateChanged(u => {
              if (u) setUser(u);
              else auth.signInAnonymously().catch(console.error);
            });
          });
      }, []);

      useEffect(() => {
        if (!user) return;
        const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);

        const unsubRec = userRef.collection("records")
          .orderBy("createdAt", "desc")
          .limit(100)
          .onSnapshot(snap => {
            // 【修復 Bug 1 & 2】強制修正 ID 問題
            // 先取出資料，如果資料內有 'id' 欄位(舊的錯誤資料)，將其刪除，避免覆蓋真正的 doc.id
            const data = snap.docs.map(d => {
                const docData = d.data();
                if ('id' in docData) delete docData.id; 
                return { id: d.id, ...docData };
            });
            setRecords(data);
            setLoading(false);
          });

        const unsubMeta = userRef.collection("metadata").doc("general")
          .onSnapshot(doc => {
            if (doc.exists) setMeta(doc.data());
            else userRef.collection("metadata").doc("general").set({ authors: [], codes: [], authorDefaults: {} });
          });

        return () => { unsubRec(); unsubMeta(); };
      }, [user]);

      const nextNumbers = useMemo(() => {
        const today = new Date();
        const rocYear = today.getFullYear() - 1911;
        const prefix = String(rocYear); 
        const mainNums = records
          .map(r => r.number)
          .filter(n => n && String(n).startsWith(prefix))
          .map(n => parseInt(n, 10))
          .filter(n => !Number.isNaN(n));
        const main = mainNums.length === 0 ? prefix + "0000001" : String(Math.max(...mainNums) + 1);

        const getSub = (type, rank) => {
          if (type === "一般公文") return "";
          const relevant = records.filter(r => r.docType === type && r.rank === rank && r.subNumber);
          const nums = relevant.map(r => parseInt(r.subNumber, 10)).filter(n => !Number.isNaN(n));
          return nums.length === 0 ? "001" : String(Math.max(...nums) + 1).padStart(3, '0');
        };
        return { main, getSub };
      }, [records]);

      useEffect(() => {
        if (!form.id) {
            const predictedSub = nextNumbers.getSub(form.docType, form.rank);
            setForm(prev => ({
                ...prev,
                number: nextNumbers.main,
                subNumber: predictedSub
            }));
        }
      }, [records, form.docType, form.rank, form.id]);

      const handleAuthorChange = (val) => {
        let update = { author: val };
        if (meta.authorDefaults && meta.authorDefaults[val]) {
          update.code = meta.authorDefaults[val];
        }
        setForm(prev => ({ ...prev, ...update }));
      };

      const saveAuthorDefault = async (authorName, defaultCode) => {
         if (!user) return;
         try {
           const newDefaults = { ...meta.authorDefaults, [authorName]: defaultCode };
           await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid)
             .collection("metadata").doc("general")
             .update({ authorDefaults: newDefaults });
           setEditingDefault(null);
         } catch(e) { console.error(e); alert("設定失敗"); }
      };

      // 【修復 Bug 3】查詢功能升級：支援日期查詢
      const handleSearch = () => {
        const hasSubject = form.subject && form.subject.trim() !== "";
        const hasDate = form.date && form.date !== "";

        if (!hasSubject && !hasDate) return alert("請輸入「主旨」或選擇「日期」進行查詢");
        
        setFilter({ 
            type: 'search', 
            value: hasSubject ? form.subject : "", // 關鍵字
            date: hasDate ? form.date : null       // 日期
        });
      };

      const handleSubmit = async (forceNew = false) => {
        if (!user) return;
        // 驗證邏輯：如果是登錄(新增)或修改，日期是必填的。但如果是純查詢操作，使用者可能會清空日期，這裡只在送出時擋。
        if (!form.date || !form.author || !form.code || !form.subject) return alert("資料不完整：日期、發文者、代字、主旨為必填");
        
        setProcessing(true);
        try {
          const userRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);
          const isNew = forceNew || !form.id;
          const finalMain = isNew ? nextNumbers.main : form.number;
          const finalSub = isNew ? nextNumbers.getSub(form.docType, form.rank) : form.subNumber;
          
          const payload = {
            ...form,
            number: finalMain,
            subNumber: finalSub,
            updatedAt: new Date().toISOString()
          };
          
          // 【修復 Bug 1 & 2】絕對不要把 id 存進去 payload
          delete payload.id; 

          if (isNew) {
            payload.createdAt = new Date().toISOString();
            await userRef.collection("records").add(payload);
          } else {
            await userRef.collection("records").doc(form.id).set(payload, { merge: true });
          }

          if (form.author && form.code) {
             await userRef.collection("metadata").doc("general").set({
               authors: firebase.firestore.FieldValue.arrayUnion(form.author),
               codes: firebase.firestore.FieldValue.arrayUnion(form.code)
             }, { merge: true });
          }

          const resetState = getInitialForm();
          resetState.date = form.date; 
          resetState.author = form.author;
          resetState.code = form.code;
          setForm(resetState);
          setFilter({type:'all', value:''});
          window.scrollTo({top:0, behavior:'smooth'});

        } catch (e) { alert("錯誤: " + e.message); } 
        finally { setProcessing(false); }
      };

      const handleDelete = async (id) => {
        if(!id) return alert("刪除失敗：無效的 ID"); // 防呆
        if(!confirm("確定刪除?")) return;
        try {
            await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("records").doc(id).delete();
            if(form.id === id) setForm(getInitialForm());
        } catch(e) {
            console.error(e);
            alert("刪除失敗");
        }
      };

      const copyToClipboard = (r) => {
         const dateText = formatDateZh(r.date);
         const numSuffix = r.number ? r.number.slice(-3) : "000";
         const text = `${dateText}${r.code}${numSuffix}號：${r.subject}`;
         
         navigator.clipboard.writeText(text).then(() => {
             const btn = document.getElementById(`copy-btn-${r.id}`);
             if(btn) {
                 const originalHTML = btn.innerHTML;
                 btn.innerHTML = '<i class="fas fa-check text-emerald-500"></i>';
                 setTimeout(()=> btn.innerHTML = originalHTML, 1500);
             }
         });
      };

      const displayRecords = useMemo(() => {
        let res = [...records];
        
        if (filter.type === 'author') res = res.filter(r => r.author === filter.value);
        if (filter.type === 'code') res = res.filter(r => r.code === filter.value);
        
        // 【修復 Bug 3】複合查詢邏輯
        if (filter.type === 'search') {
            const k = (filter.value || "").toLowerCase();
            const dateFilter = filter.date;
            
            res = res.filter(r => {
                const matchSubject = (r.subject||"").toLowerCase().includes(k) || (r.number||"").toLowerCase().includes(k);
                const matchDate = dateFilter ? r.date === dateFilter : true; // 如果有指定日期，必須符合日期
                return matchSubject && matchDate;
            });
        }

        res.sort((a, b) => {
          const numA = parseInt(a.number, 10);
          const numB = parseInt(b.number, 10);
          
          if (!Number.isNaN(numA) && !Number.isNaN(numB)) {
             return sortOrder === 'desc' ? numB - numA : numA - numB;
          } else {
             const strA = a.number || "";
             const strB = b.number || "";
             return sortOrder === 'desc' ? strB.localeCompare(strA) : strA.localeCompare(strB);
          }
        });

        return res;
      }, [records, filter, sortOrder]);

      if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">載入中...</div>;

      return (
        <div className="min-h-screen flex flex-col relative">
          
          {menuOpen && <div className="absolute inset-0 bg-black/30 z-40 backdrop-blur-sm" onClick={() => setMenuOpen(false)} />}
          <div className={`fixed inset-y-0 left-0 w-[85%] max-w-[320px] bg-white shadow-2xl z-50 sidebar flex flex-col ${menuOpen ? 'sidebar-open' : 'sidebar-closed'}`}>
            <div className="bg-slate-900 text-white p-5 pt-12 flex justify-between items-center">
              <span className="font-bold text-lg">設定選單</span>
              <button onClick={() => setMenuOpen(false)}><i className="fas fa-times text-xl"></i></button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-6">
               <button onClick={()=>{setFilter({type:'all'});setMenuOpen(false)}} className="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-700">顯示全部紀錄</button>
               
               <div>
                 <div className="flex justify-between items-end mb-2 px-1">
                    <h3 className="text-xs font-bold text-slate-400 uppercase">發文者與預設代字</h3>
                    <span className="text-[10px] text-slate-400">點擊圖示設定預設</span>
                 </div>
                 {meta.authors.map(a => (
                   <div key={a} className="flex justify-between items-center py-3 border-b border-slate-100">
                     <div className="flex-1">
                        <div onClick={()=>{setFilter({type:'author', value:a});setMenuOpen(false)}} className="text-slate-800 font-medium text-base mb-1 cursor-pointer">{a}</div>
                        <div className="text-xs text-slate-400 flex items-center gap-1">
                           {editingDefault === a ? (
                               <select 
                                 className="bg-slate-50 border border-slate-300 rounded px-1 py-0.5"
                                 value={meta.authorDefaults?.[a] || ""}
                                 onChange={(e) => saveAuthorDefault(a, e.target.value)}
                                 onBlur={() => setEditingDefault(null)}
                                 autoFocus
                               >
                                 <option value="">無預設</option>
                                 {meta.codes.map(c => <option key={c} value={c}>{c}</option>)}
                               </select>
                           ) : (
                               <span onClick={() => setEditingDefault(a)} className="cursor-pointer hover:text-blue-500 flex items-center gap-1">
                                  <i className="fas fa-link text-[10px]"></i> 
                                  {meta.authorDefaults?.[a] ? `預設: ${meta.authorDefaults[a]}` : "未設定"}
                               </span>
                           )}
                        </div>
                     </div>
                     <button onClick={async ()=>{
                        if(!confirm("移除此發文者?")) return;
                        await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general")
                          .update({ authors: firebase.firestore.FieldValue.arrayRemove(a) });
                     }} className="w-8 h-8 flex items-center justify-center text-slate-300"><i className="fas fa-trash-alt"></i></button>
                   </div>
                 ))}
               </div>
            </div>
          </div>

          <header className="bg-white/90 backdrop-blur border-b sticky top-0 z-30 px-4 h-14 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => setMenuOpen(true)} className="text-slate-700 text-lg p-1"><i className="fas fa-bars"></i></button>
              <h1 className="font-bold text-lg text-slate-800">公文系統</h1>
            </div>
            <button onClick={()=>{setForm(getInitialForm());setFilter({type:'all',value:''})}} className="text-slate-500 text-sm font-medium bg-slate-100 px-3 py-1.5 rounded-full">
              重置
            </button>
          </header>

          <main className="flex-1 w-full max-w-md mx-auto p-4 pb-24 space-y-5">
            
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 space-y-4">
              
              <div className="grid grid-cols-2 gap-3">
                <div className="space-y-1">
                  <label className="text-xs font-bold text-slate-500 ml-1">發文日期</label>
                  <div className="relative">
                      <input type="date" className="input-ios"
                        value={form.date} onChange={e=>setForm({...form, date:e.target.value})}
                      />
                      {/* 【修復 Bug 3】新增清除日期按鈕 */}
                      {form.date && (
                          <button 
                            onClick={()=>setForm({...form, date: ''})}
                            className="absolute right-8 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 p-1 bg-white"
                          >
                             <i className="fas fa-times-circle"></i>
                          </button>
                      )}
                  </div>
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-bold text-slate-500 ml-1">發文者</label>
                  <div className="select-wrapper">
                    <input type="text" list="authList" className="input-ios" placeholder="選擇"
                      value={form.author} onChange={e=>handleAuthorChange(e.target.value)}
                    />
                    <datalist id="authList">{meta.authors.map(a=><option key={a} value={a}/>)}</datalist>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div className="space-y-1">
                  <label className="text-xs font-bold text-slate-500 ml-1">文電代字</label>
                  <div className="select-wrapper">
                    <input type="text" list="codeList" className="input-ios" placeholder="選擇"
                      value={form.code} onChange={e=>setForm({...form, code:e.target.value})}
                    />
                    <datalist id="codeList">{meta.codes.map(c=><option key={c} value={c}/>)}</datalist>
                  </div>
                </div>
                <div className="space-y-1">
                   <label className="text-xs font-bold text-slate-500 ml-1">總號 (自動)</label>
                   <input type="text" readOnly 
                     className="input-ios bg-slate-50 text-slate-600 font-mono font-bold text-center tracking-wider"
                     value={form.number}
                     placeholder="自動產生"
                   />
                </div>
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold text-slate-500 ml-1">主旨</label>
                <textarea rows="2" placeholder="輸入內容..."
                   className="w-full bg-white border border-slate-200 rounded-xl px-3 py-3 text-base outline-none resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition"
                   value={form.subject} onChange={e=>setForm({...form, subject:e.target.value})}
                ></textarea>
              </div>

              <div className="pt-2 space-y-3">
                <div className="flex gap-2 p-1 bg-slate-100 rounded-lg">
                   {['一般公文','獎懲','調職(晉升)'].map(t => (
                     <button key={t} onClick={()=>setForm({...form, docType:t})}
                       className={`flex-1 py-2 text-xs rounded-md font-bold transition-all shadow-sm ${form.docType===t ? 'bg-white text-blue-600 shadow-sm' : 'bg-transparent text-slate-400 hover:text-slate-600'}`}>
                       {t}
                     </button>
                   ))}
                </div>
                
                {form.docType !== '一般公文' && (
                  <div className="flex gap-2 p-1 bg-slate-100 rounded-lg animate-fade-in">
                     {['軍官','士官','士兵'].map(r => (
                       <button key={r} onClick={()=>setForm({...form, rank:r})}
                         className={`flex-1 py-2 text-xs rounded-md font-bold transition-all ${form.rank===r ? 'bg-indigo-600 text-white shadow-sm' : 'bg-transparent text-slate-400 hover:text-slate-600'}`}>
                         {r}
                       </button>
                     ))}
                  </div>
                )}
              </div>

              <div className="grid grid-cols-4 gap-2 pt-2">
                 <button onClick={handleSearch} 
                   className="col-span-1 h-12 rounded-xl border border-slate-300 text-slate-600 font-bold bg-white active:scale-95">
                   查詢
                 </button>
                 
                 <button onClick={()=>handleSubmit(false)} disabled={!form.id} 
                   className={`col-span-1 h-12 rounded-xl border font-bold ${form.id ? 'bg-blue-50 text-blue-600 border-blue-200':'bg-slate-50 text-slate-300 border-slate-100'}`}>
                   修改
                 </button>
                 
                 <button onClick={()=>handleSubmit(true)} disabled={processing}
                   className="col-span-2 h-12 rounded-xl bg-slate-900 text-white font-bold shadow-lg shadow-slate-200 active:scale-95 transition flex justify-center items-center">
                   {processing ? <i className="fas fa-circle-notch fa-spin"></i> : "登錄"}
                 </button>
              </div>
            </div>

            <div className="space-y-4">
              <div className="flex justify-between items-end px-2">
                <div className="flex items-center gap-3">
                   <h2 className="font-bold text-slate-800 text-lg">
                      發文紀錄 
                      {filter.type !== 'all' && <span className="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">
                          {filter.type === 'search' ? '搜尋模式' : filter.value}
                      </span>}
                   </h2>
                   <button 
                     onClick={() => setSortOrder(prev => prev === 'desc' ? 'asc' : 'desc')}
                     className="bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm active:scale-95 transition"
                   >
                      <i className={`fas fa-sort-numeric-${sortOrder === 'desc' ? 'down' : 'up'}`}></i>
                      {sortOrder === 'desc' ? '新→舊' : '舊→新'}
                   </button>
                </div>
                
                {filter.type !== 'all' && <button onClick={()=>setFilter({type:'all'})} className="text-sm text-blue-500 font-bold">清除</button>}
              </div>
              
              {displayRecords.map(r => (
                <div key={r.id} onClick={()=>{setForm({...r}); window.scrollTo({top:0,behavior:'smooth'})}}
                   className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm active:bg-slate-50 transition relative overflow-hidden group">
                   
                   <div className="flex justify-between items-start mb-1">
                      <span className="font-mono font-bold text-blue-600 text-lg tracking-tight">#{r.number}</span>
                      <div className="text-xs text-slate-400 font-mono">{r.date}</div>
                   </div>

                   <div className="text-base font-bold text-slate-800 mb-3 line-clamp-2">{r.subject}</div>

                   <div className="flex justify-between items-center pt-3 border-t border-slate-50">
                      <div className="flex items-center gap-2 text-xs text-slate-500 font-bold">
                         <span className="bg-slate-100 px-2 py-1 rounded-md">{r.author}</span>
                         <span className="bg-slate-100 px-2 py-1 rounded-md">{r.code}</span>
                         {r.docType !== '一般公文' && <span className="bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md">{r.docType} {r.rank}-{r.subNumber}</span>}
                      </div>

                      <div className="flex gap-1">
                        <button id={`copy-btn-${r.id}`} onClick={(e)=>{ e.stopPropagation(); copyToClipboard(r); }}
                           className="h-8 px-3 flex items-center gap-1 bg-emerald-50 text-emerald-600 rounded-lg border border-emerald-100 font-bold text-xs active:scale-90 transition"
                        >
                           <i className="fas fa-copy"></i> 複製
                        </button>
                        
                        <button onClick={(e)=>{e.stopPropagation();handleDelete(r.id)}} 
                           className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-500 bg-slate-50 rounded-lg">
                           <i className="fas fa-trash-alt"></i>
                        </button>
                      </div>
                   </div>
                </div>
              ))}
            </div>

          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
