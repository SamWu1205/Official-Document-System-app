<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>公文發文系統 (最終修正版)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { background-color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    
    /* 側邊欄 */
    .sidebar { transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
    .sidebar-closed { transform: translateX(-100%); }
    .sidebar-open { transform: translateX(0); }
    
    /* 隱藏滾動條 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* 強制統一輸入框高度 */
    .input-std {
      height: 44px;
      line-height: normal;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    // ======================
    // 1. Firebase Config
    // ======================
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.firebasestorage.app",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
      measurementId: "G-B9R46YLGXQ",
    };

    // ⚠️ 固定 ID，避免資料遺失。請勿更改此行。
    const CURRENT_APP_ID = "dispatch-system-final-v1"; 

    try { firebase.initializeApp(firebaseConfig); } 
    catch (e) { /* ignore */ }

    const auth = firebase.auth();
    const db = firebase.firestore();

    const { useState, useEffect, useMemo } = React;

    // ======================
    // 2. Main App
    // ======================
    function App() {
      // 資料 State
      const [user, setUser] = useState(null);
      const [records, setRecords] = useState([]);
      const [meta, setMeta] = useState({ authors: [], codes: [], authorDefaults: {} });
      const [loading, setLoading] = useState(true);
      
      // UI State
      const [menuOpen, setMenuOpen] = useState(false);
      const [processing, setProcessing] = useState(false);
      const [filter, setFilter] = useState({ type: 'all', value: '' });

      // 表單 State
      const initialForm = {
        id: null,
        date: new Date().toISOString().split("T")[0],
        author: "",
        code: "",
        number: "",      // 總號 (114xxxx)
        subject: "",
        docType: "一般公文", 
        rank: "軍官",
        subNumber: ""    // 分類小號 (例如: 軍官001)
      };
      const [form, setForm] = useState(initialForm);

      // --- 初始化 ---
      useEffect(() => {
        auth.signInAnonymously().catch(console.error);
        return auth.onAuthStateChanged(u => setUser(u));
      }, []);

      useEffect(() => {
        if (!user) return;
        
        // 監聽紀錄
        const recordsRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("records");
        const unsubRec = recordsRef.orderBy("createdAt", "desc").onSnapshot(snap => {
          setRecords(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          setLoading(false);
        });

        // 監聽 Metadata (發文者/代字清單)
        const metaRef = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general");
        const unsubMeta = metaRef.onSnapshot(doc => {
          if (doc.exists) setMeta(doc.data());
          else metaRef.set({ authors: [], codes: [], authorDefaults: {} }); // 初始建立
        });

        return () => { unsubRec(); unsubMeta(); };
      }, [user]);

      // --- 核心邏輯：流水號 ---

      // 1. 產生總號 (Global Number)
      const generateMainNumber = () => {
        const today = new Date();
        const rocYear = today.getFullYear() - 1911;
        const prefix = String(rocYear); 
        
        // 找出所有 114 開頭的號碼，不分公文種類
        const nums = records
          .map(r => r.number)
          .filter(n => n && String(n).startsWith(prefix))
          .map(n => parseInt(n, 10))
          .filter(n => !Number.isNaN(n));

        if (nums.length === 0) return prefix + "0000001";
        return String(Math.max(...nums) + 1);
      };

      // 2. 產生分類小號 (Sub Number) - 針對 獎懲/調職 + 階級
      const generateSubNumber = (targetType, targetRank) => {
        if (targetType === "一般公文") return ""; // 一般公文沒有小號

        // 篩選：同種類 (獎懲=獎懲) AND 同階級 (軍官=軍官)
        const relevant = records.filter(r => 
          r.docType === targetType && r.rank === targetRank && r.subNumber
        );

        // 找出目前最大號
        const nums = relevant.map(r => parseInt(r.subNumber, 10)).filter(n => !Number.isNaN(n));
        
        if (nums.length === 0) return "001"; // 第一號
        const next = Math.max(...nums) + 1;
        return String(next).padStart(3, '0'); // 補零為 002
      };

      // --- 動作處理 ---

      const handleAuthorChange = (val) => {
        let update = { author: val };
        // 自動帶入代字
        if (meta.authorDefaults?.[val] && !form.code) {
          update.code = meta.authorDefaults[val];
        }
        setForm(prev => ({ ...prev, ...update }));
      };

      const handleClear = () => {
        if(confirm("確定要清除目前輸入的內容嗎？")) {
           setForm(initialForm);
           window.scrollTo({top:0, behavior:'smooth'});
        }
      };

      // 登錄 / 更改
      const handleSubmit = async (forceNew = false) => {
        if (!user) return;
        if (!form.date || !form.author || !form.code || !form.subject) {
          alert("請填寫完整資訊 (日期、發文者、代字、主旨)");
          return;
        }

        setProcessing(true);
        try {
          const userDoc = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid);
          
          // 計算號碼
          let finalMainNum = form.number;
          let finalSubNum = form.subNumber;
          
          // 如果是「新登錄」或是「強制另存」，才需要重新取號
          // 若是「更改」且已經有號碼，則維持原號
          const isNew = forceNew || !form.id;

          if (isNew) {
            finalMainNum = generateMainNumber();
            if (form.docType !== "一般公文") {
              finalSubNum = generateSubNumber(form.docType, form.rank);
            } else {
              finalSubNum = "";
            }
          }

          const payload = {
            ...form,
            id: null, // 確保不存入 ID 欄位
            number: finalMainNum,
            subNumber: finalSubNum,
            updatedAt: new Date().toISOString(),
          };

          if (isNew) {
            payload.createdAt = new Date().toISOString();
            await userDoc.collection("records").add(payload);
          } else {
            // 更新現有
            await userDoc.collection("records").doc(form.id).set(payload, { merge: true });
          }

          // **關鍵修正：更新 Metadata (側邊欄選單)**
          // 確保輸入的新名字/代字被記錄
          const metaRef = userDoc.collection("metadata").doc("general");
          await db.runTransaction(async (t) => {
            const doc = await t.get(metaRef);
            const data = doc.data() || { authors: [], codes: [], authorDefaults: {} };
            let changed = false;

            if (form.author && !data.authors.includes(form.author)) {
              data.authors.push(form.author);
              changed = true;
            }
            if (form.code && !data.codes.includes(form.code)) {
              data.codes.push(form.code);
              changed = true;
            }
            if (changed) {
              t.set(metaRef, data, { merge: true });
            }
          });

          alert(isNew ? `✅ 登錄成功！\n總號：${finalMainNum}` + (finalSubNum ? `\n分類號：${finalSubNum}` : "") : "✅ 資料已更新");

          // 發文後自動清空，準備下一筆
          setForm(initialForm);
          window.scrollTo({top:0, behavior:'smooth'});

        } catch (e) {
          console.error(e);
          alert("儲存失敗：" + e.message);
        } finally {
          setProcessing(false);
        }
      };

      // 刪除
      const handleDelete = async (id) => {
        if(!confirm("確定刪除此紀錄？")) return;
        await db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("records").doc(id).delete();
        if(form.id === id) setForm(initialForm);
      };

      // 側邊欄管理
      const deleteMeta = async (type, val) => {
        if(!confirm(`確定移除選單項目「${val}」？`)) return;
        const ref = db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general");
        const doc = await ref.get();
        if(!doc.exists) return;
        const data = doc.data();
        if(type === 'author') ref.update({ authors: data.authors.filter(x => x !== val) });
        else ref.update({ codes: data.codes.filter(x => x !== val) });
      };

      const setAuthorDefault = async (author) => {
        const code = prompt(`設定 ${author} 的預設代字：`, meta.authorDefaults?.[author] || "");
        if(code === null) return;
        db.collection("artifacts").doc(CURRENT_APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general")
          .set({ authorDefaults: { ...meta.authorDefaults, [author]: code } }, { merge: true });
      };

      // 列表顯示
      const displayRecords = useMemo(() => {
        let res = [...records];
        if (filter.type === 'author') res = res.filter(r => r.author === filter.value);
        if (filter.type === 'code') res = res.filter(r => r.code === filter.value);
        if (filter.type === 'search') {
            const k = filter.value.toLowerCase();
            res = res.filter(r => (r.subject||"").includes(k) || (r.number||"").includes(k));
        }
        return res; // 預設已在 fetch 時用 createdAt desc 排序
      }, [records, filter]);

      // --- UI Render ---
      if (!user && loading) return <div className="h-screen flex items-center justify-center text-slate-500">系統連線中...</div>;

      return (
        <div className="min-h-screen flex flex-col relative overflow-hidden">
          
          {/* 側邊欄 Overlay */}
          {menuOpen && <div className="absolute inset-0 bg-black/60 z-30 backdrop-blur-sm" onClick={() => setMenuOpen(false)} />}
          
          {/* 側邊欄 */}
          <div className={`fixed inset-y-0 left-0 w-72 bg-white shadow-2xl z-40 sidebar flex flex-col ${menuOpen ? 'sidebar-open' : 'sidebar-closed'}`}>
            <div className="bg-slate-800 text-white p-4 font-bold flex justify-between items-center">
              <span>設定選單</span>
              <button onClick={() => setMenuOpen(false)}><i className="fas fa-times"></i></button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-6">
               <button onClick={()=>{setFilter({type:'all'});setMenuOpen(false)}} className="w-full py-2 bg-slate-100 rounded font-bold text-slate-700">顯示全部紀錄</button>
               
               {/* 發文者管理 */}
               <div>
                 <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">發文者</h3>
                 {meta.authors.map(a => (
                   <div key={a} className="flex justify-between items-center py-2 border-b border-slate-100 last:border-0">
                     <button onClick={()=>{setFilter({type:'author', value:a});setMenuOpen(false)}} className="text-slate-700 font-medium">{a}</button>
                     <div className="flex gap-3 text-slate-300">
                       <button onClick={()=>setAuthorDefault(a)} className="hover:text-blue-500"><i className="fas fa-cog"></i></button>
                       <button onClick={()=>deleteMeta('author', a)} className="hover:text-red-500"><i className="fas fa-trash-alt"></i></button>
                     </div>
                   </div>
                 ))}
                 {meta.authors.length===0 && <div className="text-xs text-slate-300">發文後自動新增</div>}
               </div>

               {/* 代字管理 */}
               <div>
                 <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">文電代字</h3>
                 {meta.codes.map(c => (
                   <div key={c} className="flex justify-between items-center py-2 border-b border-slate-100 last:border-0">
                     <button onClick={()=>{setFilter({type:'code', value:c});setMenuOpen(false)}} className="text-slate-700 font-medium">{c}</button>
                     <button onClick={()=>deleteMeta('code', c)} className="text-slate-300 hover:text-red-500"><i className="fas fa-trash-alt"></i></button>
                   </div>
                 ))}
               </div>
            </div>
          </div>

          {/* Header */}
          <header className="bg-white border-b sticky top-0 z-20 px-4 h-14 flex items-center justify-between shadow-sm">
            <div className="flex items-center gap-3">
              <button onClick={() => setMenuOpen(true)} className="text-slate-600 text-lg p-1"><i className="fas fa-bars"></i></button>
              <h1 className="font-bold text-lg text-slate-800">公文發文系統</h1>
            </div>
            {/* 清除按鈕 */}
            <button onClick={handleClear} className="text-red-500 font-bold text-sm px-3 py-1 rounded-full bg-red-50 hover:bg-red-100 transition">
              <i className="fas fa-eraser mr-1"></i>清除
            </button>
          </header>

          <main className="flex-1 max-w-lg mx-auto w-full p-3 pb-20 space-y-4">
            
            {/* 輸入區塊 */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 space-y-4">
              
              {/* Row 1: 日期 & 發文者 */}
              <div className="grid grid-cols-2 gap-3">
                <div className="flex flex-col gap-1">
                  <label className="text-xs font-bold text-slate-500 ml-1">發文日期</label>
                  <input type="date" 
                    className="w-full bg-slate-50 border border-slate-300 rounded-lg px-2 text-sm input-std focus:ring-2 focus:ring-blue-500 outline-none"
                    value={form.date} onChange={e=>setForm({...form, date:e.target.value})}
                  />
                </div>
                <div className="flex flex-col gap-1">
                  <label className="text-xs font-bold text-slate-500 ml-1">發文者</label>
                  <div className="relative">
                    <input type="text" list="authList" placeholder="輸入或選擇"
                      className="w-full bg-slate-50 border border-slate-300 rounded-lg px-2 text-sm input-std focus:ring-2 focus:ring-blue-500 outline-none"
                      value={form.author} onChange={e=>handleAuthorChange(e.target.value)}
                    />
                    <datalist id="authList">{meta.authors.map(a=><option key={a} value={a}/>)}</datalist>
                    <i className="fas fa-caret-down absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                  </div>
                </div>
              </div>

              {/* Row 2: 代字 & 總號 */}
              <div className="grid grid-cols-2 gap-3">
                <div className="flex flex-col gap-1">
                  <label className="text-xs font-bold text-slate-500 ml-1">文電代字</label>
                  <div className="relative">
                    <input type="text" list="codeList" placeholder="輸入或選擇"
                      className="w-full bg-slate-50 border border-slate-300 rounded-lg px-2 text-sm input-std focus:ring-2 focus:ring-blue-500 outline-none"
                      value={form.code} onChange={e=>setForm({...form, code:e.target.value})}
                    />
                    <datalist id="codeList">{meta.codes.map(c=><option key={c} value={c}/>)}</datalist>
                    <i className="fas fa-caret-down absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                  </div>
                </div>
                <div className="flex flex-col gap-1">
                   <div className="flex justify-between items-baseline px-1">
                     <label className="text-xs font-bold text-slate-500">總號 (流水號)</label>
                     <span className="text-[10px] text-slate-400">系統自動產生</span>
                   </div>
                   <input type="text" readOnly placeholder="發文後自動產生"
                     className="w-full bg-slate-100 border border-slate-200 rounded-lg px-2 text-sm input-std text-slate-400 cursor-not-allowed"
                     value={form.number}
                   />
                </div>
              </div>

              {/* Row 3: 主旨 */}
              <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-slate-500 ml-1">主旨</label>
                <textarea rows="2" placeholder="請輸入公文主旨..."
                   className="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                   value={form.subject} onChange={e=>setForm({...form, subject:e.target.value})}
                ></textarea>
              </div>

              {/* Row 4: 公文種類 */}
              <div className="space-y-2 pt-1 border-t border-slate-100">
                <div className="flex items-center gap-2">
                   <span className="text-xs font-bold text-slate-500">公文種類：</span>
                   <div className="flex bg-slate-100 p-1 rounded-lg">
                      {['一般公文','獎懲','調職(晉升)'].map(t => (
                        <button key={t} onClick={()=>setForm({...form, docType:t})}
                          className={`px-3 py-1 text-xs rounded-md font-bold transition-all ${form.docType===t ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>
                          {t}
                        </button>
                      ))}
                   </div>
                </div>

                {/* Row 5: 階級 (條件顯示) */}
                {form.docType !== '一般公文' && (
                  <div className="flex items-center gap-2 animate-fadeIn">
                     <span className="text-xs font-bold text-slate-500">適用階級：</span>
                     <div className="flex bg-slate-100 p-1 rounded-lg">
                        {['軍官','士官','士兵'].map(r => (
                          <button key={r} onClick={()=>setForm({...form, rank:r})}
                            className={`px-3 py-1 text-xs rounded-md font-bold transition-all ${form.rank===r ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>
                            {r}
                          </button>
                        ))}
                     </div>
                  </div>
                )}
                {form.docType !== '一般公文' && (
                  <div className="text-[10px] text-indigo-500 px-1">
                    * 將自動產生 {form.docType}-{form.rank} 專用分類編號
                  </div>
                )}
              </div>

              {/* Row 6: 按鈕 */}
              <div className="grid grid-cols-3 gap-3 pt-2">
                 <button onClick={()=>{
                   if(!form.subject) return alert("請輸入關鍵字");
                   setFilter({type:'search', value:form.subject});
                 }} className="py-2.5 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm bg-white active:scale-95 transition">
                   <i className="fas fa-search mr-1"></i>查詢
                 </button>
                 
                 <button onClick={()=>handleSubmit(false)} disabled={!form.id} 
                   className={`py-2.5 rounded-lg border font-bold text-sm transition ${form.id ? 'border-blue-200 bg-blue-50 text-blue-600 active:scale-95':'border-slate-100 text-slate-300 cursor-not-allowed'}`}>
                   <i className="fas fa-pen mr-1"></i>更改
                 </button>
                 
                 <button onClick={()=>handleSubmit(true)} disabled={processing}
                   className="py-2.5 rounded-lg bg-slate-800 text-white font-bold text-sm shadow-md active:scale-95 transition flex justify-center items-center">
                   {processing ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-file-export mr-1"></i>登錄</>}
                 </button>
              </div>
            </div>

            {/* 列表區 */}
            <div className="space-y-3">
              <div className="flex justify-between items-end px-2">
                <h2 className="font-bold text-slate-700">發文紀錄</h2>
                <span className="text-xs text-slate-400">排序: 由新到舊</span>
              </div>
              
              {displayRecords.map(r => (
                <div key={r.id} onClick={()=>{setForm({...r}); window.scrollTo({top:0,behavior:'smooth'})}}
                   className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm relative active:bg-blue-50 transition">
                   
                   <div className="flex justify-between items-start mb-2">
                      <div className="text-[11px] font-mono text-slate-500 flex gap-2 items-center">
                        <span>{r.date}</span>
                        <span className="px-1.5 py-0.5 bg-slate-100 rounded text-slate-600">{r.code}</span>
                        <span className="text-blue-600 font-bold text-sm">{r.number}</span>
                      </div>
                      <i className="far fa-copy text-slate-300 p-1 active:text-blue-600" 
                         onClick={(e)=>{e.stopPropagation();navigator.clipboard.writeText(`${r.code}字第${r.number}號 ${r.subject}`); alert("已複製")}}
                      ></i>
                   </div>

                   <div className="text-sm font-medium text-slate-800 mb-2">{r.subject}</div>

                   <div className="flex justify-between items-center border-t border-slate-50 pt-2">
                      <div className="flex gap-2">
                        <span className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full flex items-center">
                           <i className="fas fa-user-circle mr-1"></i>{r.author}
                        </span>
                        {r.docType !== '一般公文' && (
                           <span className="text-[10px] bg-indigo-50 text-indigo-600 border border-indigo-100 px-2 py-0.5 rounded-full font-bold">
                             {r.docType}-{r.rank} 第 {r.subNumber} 號
                           </span>
                        )}
                      </div>
                      <button onClick={(e)=>{e.stopPropagation();handleDelete(r.id)}} className="text-xs text-red-300 hover:text-red-500 px-2">刪除</button>
                   </div>
                </div>
              ))}
            </div>

          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>