<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>公文發文系統</title>
    
    <!-- 1. 錯誤偵測腳本 (若畫面空白會跳出警告) -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("系統發生錯誤，請截圖給工程師：\n" + msg);
            return false;
        };
    </script>

    <!-- 2. 載入必要核心 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ------------------------------------------------------------------
        // 3. Firebase 設定 (已填入你的金鑰)
        // ------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
            authDomain: "official-document-system-239ab.firebaseapp.com",
            projectId: "official-document-system-239ab",
            storageBucket: "official-document-system-239ab.firebasestorage.app",
            messagingSenderId: "285835980582",
            appId: "1:285835980582:web:feb116841184884f685be7",
            measurementId: "G-B9R46YLGXQ"
        };

        const GEMINI_API_KEY = ""; // AI 功能金鑰 (選填)

        // 初始化 Firebase
        let app, auth, db, appId = "dispatch-system-user-v1";
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase 初始化失敗", e);
            alert("無法連線至資料庫，請檢查網路。");
        }

        const { useState, useEffect, useMemo } = React;

        // --- 4. 內建圖示定義 (修正版) ---
        const Icon = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Menu = (p) => <Icon {...p}><path d="M4 6h16M4 12h16M4 18h16"/></Icon>;
        const Calendar = (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const User = (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Edit = (p) => <Icon {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>;
        const Plus = (p) => <Icon {...p}><path d="M5 12h14M12 5v14"/></Icon>;
        const Copy = (p) => <Icon {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>;
        const X = (p) => <Icon {...p}><path d="M18 6 6 18M6 6l12 12"/></Icon>;
        const Check = (p) => <Icon {...p}><path d="M20 6 9 17l-5-5"/></Icon>;
        const ChevronDown = (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>;
        const ClipboardList = (p) => <Icon {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></Icon>;
        const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>;
        const Loader2 = (p) => <Icon {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>;
        const Trash2 = (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Briefcase = (p) => <Icon {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>;
        const Award = (p) => <Icon {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></Icon>;
        const ArrowRightLeft = (p) => <Icon {...p}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></Icon>;
        const Tag = (p) => <Icon {...p}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><circle cx="7" cy="7" r="2.5"/></Icon>;
        const ArrowDownUp = (p) => <Icon {...p}><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></Icon>;
        const Maximize2 = (p) => <Icon {...p}><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/></Icon>;
        const Minimize2 = (p) => <Icon {...p}><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" x2="21" y1="10" y2="3"/><line x1="3" x2="10" y1="21" y2="14"/></Icon>;
        const Settings = (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const Save = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const Cloud = (p) => <Icon {...p}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.9-2.4-5.2-5.3-5.2-2.6 0-4.8 1.9-5.2 4.4C1.1 15.6 0 17 0 18.5c0 2.5 2 4.5 4.5 4.5h13c2.5 0 4.5-2 4.5-4.5s-2-4.5-4.5-4.5z"/></Icon>;
        const FileText = (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></Icon>;

        const INITIAL_AUTHORS_SEED = ['黃〇〇', '吳〇〇', '謝〇〇', '陳〇〇'];
        const INITIAL_CODES_SEED = ['陸十平武', '陸十軍人', '陸十軍補', '陸十軍情'];
        const ADMIN_TYPES = {
            general: { label: '一般公文', icon: 'FileText', prefix: '' },
            award: { label: '獎懲業務', icon: 'Award', prefix: '人勤令' },
            transfer: { label: '調職/晉升', icon: 'ArrowRightLeft', prefix: '人職令' },
        };
        const RANKS = [
            { id: 'officer', label: '軍官', short: '官' },
            { id: 'nco', label: '士官', short: '士' },
            { id: 'soldier', label: '士兵', short: '兵' },
        ];

        async function callGemini(prompt) {
            if (!GEMINI_API_KEY) { 
                alert("如需使用 AI 功能，請在 index.html 中填入 GEMINI_API_KEY"); 
                return null; 
            }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                });
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) { console.error(error); alert("AI 連線失敗"); return null; }
        }

        function App() {
            const [user, setUser] = useState(null);
            const [records, setRecords] = useState([]);
            const [authorsList, setAuthorsList] = useState([]);
            const [codesList, setCodesList] = useState([]);
            const [authorDefaults, setAuthorDefaults] = useState({});
            
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [selectedOfficer, setSelectedOfficer] = useState('所有');
            const [isSettingsMode, setIsSettingsMode] = useState(false);
            const [editingDefaultAuthor, setEditingDefaultAuthor] = useState(null);
            const [tempDefaultCode, setTempDefaultCode] = useState("");
            
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [showSmartFillModal, setShowSmartFillModal] = useState(false);
            const [smartFillText, setSmartFillText] = useState("");

            const [formData, setFormData] = useState({ id: null, date: new Date().toISOString().split('T')[0], author: '', code: '', number: '', subject: '' });
            const [adminType, setAdminType] = useState('general');
            const [selectedRank, setSelectedRank] = useState(null);
            const [adminNumber, setAdminNumber] = useState('');

            const [searchMode, setSearchMode] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [sortOrder, setSortOrder] = useState('newest');
            const [isListExpanded, setIsListExpanded] = useState(false);

            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Error:", error);
                        alert("登入失敗：" + error.message);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'records');
                const unsubRecords = onSnapshot(recordsRef, (s) => setRecords(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const settingsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'settings');
                const unsubSettings = onSnapshot(settingsRef, (s) => {
                    let aFound = false, cFound = false;
                    s.docs.forEach(d => {
                        const data = d.data();
                        if (d.id === 'lists') {
                            if (data.authors) { setAuthorsList(data.authors); aFound = true; }
                            if (data.codes) { setCodesList(data.codes); cFound = true; }
                        }
                        if (d.id === 'defaults') {
                            setAuthorDefaults(data);
                        }
                    });

                    if (!aFound || !cFound) {
                         const listsDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'lists');
                         setDoc(listsDocRef, {
                             authors: authorsFound ? undefined : INITIAL_AUTHORS_SEED,
                             codes: codesFound ? undefined : INITIAL_CODES_SEED
                         }, { merge: true });
                    }

                }, (error) => console.error("Settings sync error:", error));

                return () => {
                    unsubRecords();
                    unsubSettings();
                };
            }, [user]);

            const generateNextNumber = (curr) => {
                const prefix = `${new Date().getFullYear() - 1911}`;
                const rel = curr.map(r => r.number).filter(n => n && n.toString().startsWith(prefix)).map(n => parseInt(n, 10)).filter(n => !isNaN(n));
                return rel.length === 0 ? `${prefix}0000001` : (Math.max(...rel) + 1).toString();
            };

            const generateNextAdminNumber = (curr, type, rankId) => {
                const prefix = ADMIN_TYPES[type]?.prefix;
                const rankShort = RANKS.find(r => r.id === rankId)?.short;
                if (!prefix || !rankShort) return '001';
                const target = `${prefix}(${rankShort})`;
                const rel = curr.filter(r => r.adminTag && r.adminTag.startsWith(target)).map(r => parseInt(r.adminTag.replace(target, '').replace('號', ''), 10)).filter(n => !isNaN(n));
                return rel.length === 0 ? '001' : (Math.max(...rel) + 1).toString().padStart(3, '0');
            };

            const displayRecords = useMemo(() => {
                let res = [...records];
                if (selectedOfficer !== '所有') res = res.filter(r => r.author === selectedOfficer);
                if (searchMode && searchQuery) res = res.filter(r => r.subject.includes(searchQuery) || r.number.includes(searchQuery) || r.code.includes(searchQuery));
                res.sort((a, b) => {
                    const nA = parseInt(a.number, 10), nB = parseInt(b.number, 10);
                    if (!isNaN(nA) && !isNaN(nB)) return sortOrder === 'newest' ? nB - nA : nA - nB;
                    if (a.number !== b.number) return sortOrder === 'newest' ? String(b.number).localeCompare(String(a.number)) : String(a.number).localeCompare(String(b.number));
                    return sortOrder === 'newest' ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date);
                });
                return res;
            }, [records, selectedOfficer, searchMode, searchQuery, sortOrder]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (name === 'author') {
                  const defaultCode = authorDefaults[value];
                  if (defaultCode) {
                     setFormData(prev => ({ ...prev, [name]: value, code: defaultCode }));
                     return;
                  }
                }
                setFormData(prev => ({ ...prev, [name]: value }));
            };
  
            const handleAdminTypeChange = (type) => {
                setAdminType(type);
                if (type === 'general') {
                  setSelectedRank(null);
                  setAdminNumber('');
                } else {
                    setAdminNumber('');
                }
            };

            const getAdminTagPreview = () => {
                if (adminType === 'general') return '';
                if (!selectedRank) return '';
                const prefix = ADMIN_TYPES[adminType].prefix;
                const rankShort = RANKS.find(r => r.id === selectedRank)?.short || '';
                const numberDisplay = adminNumber || '???';
                return `${prefix}(${rankShort})${numberDisplay}號`;
            };

            const constructAdminTag = (type, rank, number) => {
                 if (type === 'general') return '';
                 const prefix = ADMIN_TYPES[type].prefix;
                 const rankShort = RANKS.find(r => r.id === rank)?.short || '';
                 return `${prefix}(${rankShort})${number}號`;
            };
            
            const handleAddItem = async (type) => {
                if (!user) return;
                const isAuthor = type === 'author';
                const list = isAuthor ? authorsList : codesList;
                const label = isAuthor ? '發文者' : '文電代字';
                const fieldName = isAuthor ? 'authors' : 'codes';

                const newValue = prompt(`請輸入新的${label}：`);
                if (newValue && newValue.trim()) {
                   const trimmed = newValue.trim();
                   if (!list.includes(trimmed)) {
                     const newList = [...list, trimmed];
                     if (isAuthor) setAuthorsList(newList); else setCodesList(newList);
                     
                     const listsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'lists');
                     try {
                        await setDoc(listsRef, { [fieldName]: newList }, { merge: true });
                        setFormData(prev => ({ ...prev, [type]: trimmed }));
                     } catch (e) {
                         console.error("Add item error", e);
                         alert("新增失敗，請檢查網路連線");
                     }
                   } else {
                       setFormData(prev => ({ ...prev, [type]: trimmed }));
                   }
                }
            };

            const handleDeleteItem = async (type) => {
                if (!user) return;
                const isAuthor = type === 'author';
                const list = isAuthor ? authorsList : codesList;
                const label = isAuthor ? '發文者' : '文電代字';
                const fieldName = isAuthor ? 'authors' : 'codes';
                const currentValue = formData[type];

                if (!currentValue || !list.includes(currentValue)) {
                  alert(`請先選擇清單中的${label}才能刪除`);
                  return;
                }
                if (window.confirm(`確定要將「${currentValue}」從${label}選單中永久移除嗎？`)) {
                  const newList = list.filter(item => item !== currentValue);
                  if (isAuthor) setAuthorsList(newList); else setCodesList(newList);
                  
                  const listsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'lists');
                  try {
                     await setDoc(listsRef, { [fieldName]: newList }, { merge: true });
                     setFormData(prev => ({ ...prev, [type]: '' }));
                  } catch (e) {
                      console.error("Delete item error", e);
                      alert("連線不穩定，請重試");
                  }
                }
            };

            const handleSearch = () => {
                const query = formData.subject.trim() || formData.number.trim();
                if (!query) {
                  alert("請輸入主旨或字號關鍵字");
                  setSearchMode(false);
                  setSearchQuery("");
                  return;
                }
                setSearchQuery(query);
                setSearchMode(true);
            };

            const handleRegister = async () => {
                if (!user) return;
                if (!formData.date || !formData.author || !formData.code) {
                  alert("請至少填寫：日期、發文者、文電代字");
                  return;
                }

                let finalNumber = formData.number;
                if (!finalNumber) {
                  finalNumber = generateNextNumber(records);
                }

                let finalAdminTag = '';
                let finalAdminNumber = adminNumber;

                if (adminType !== 'general') {
                    if (!selectedRank) {
                        alert("特殊行政業務請選擇「身分」");
                        return;
                    }
                    if (!finalAdminNumber) {
                        finalAdminNumber = generateNextAdminNumber(records, adminType, selectedRank);
                    }
                    finalAdminTag = constructAdminTag(adminType, selectedRank, finalAdminNumber);
                } else {
                    if (!formData.subject) {
                        alert("一般公文請填寫主旨");
                        return;
                    }
                }

                const newRecord = {
                  ...formData,
                  number: finalNumber,
                  adminTag: finalAdminTag,
                  createdAt: new Date().toISOString()
                };
                delete newRecord.id;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'records'), newRecord);
                    
                    let msg = `公文登錄成功！\n字號: ${finalNumber}`;
                    if (finalAdminTag) msg += `\n令號: ${finalAdminTag}`;
                    alert(msg);

                    setFormData(prev => ({ ...prev, id: null, number: '', subject: '' }));
                    setAdminNumber('');
                } catch (e) {
                    console.error("Register error", e);
                    alert("資料庫連線錯誤，請檢查網路");
                }
            };

            const handleEditLoad = (record) => {
                setFormData(record);
                
                if (record.adminTag) {
                  if (record.adminTag.includes('人勤令')) setAdminType('award');
                  else if (record.adminTag.includes('人職令')) setAdminType('transfer');
                  else setAdminType('general');

                  if (record.adminTag.includes('(官)')) setSelectedRank('officer');
                  else if (record.adminTag.includes('(士)')) setSelectedRank('nco');
                  else if (record.adminTag.includes('(兵)')) setSelectedRank('soldier');
                  
                  const match = record.adminTag.match(/\)(\d+)號/);
                  if (match) setAdminNumber(match[1]);
                } else {
                  setAdminType('general');
                  setSelectedRank(null);
                  setAdminNumber('');
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleUpdate = async () => {
                if (!user) return;
                if (!formData.id) {
                  alert("請先選擇紀錄進行修改");
                  return;
                }
                
                let finalAdminTag = '';
                if (adminType !== 'general') {
                     if (!selectedRank || !adminNumber) {
                         alert("修改行政業務時，身分與令號不得為空");
                         return;
                     }
                     finalAdminTag = constructAdminTag(adminType, selectedRank, adminNumber);
                }

                const updatedData = { ...formData, adminTag: finalAdminTag };
                const docId = updatedData.id;
                delete updatedData.id; 

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'records', docId), updatedData);
                    alert("資料更新成功！");
                    setFormData({ ...formData, id: null, number: '', subject: '' });
                    setAdminType('general');
                    setAdminNumber('');
                } catch (e) {
                    console.error("Update error", e);
                    alert("更新失敗，請檢查網路");
                }
            };

            const handleCopy = (record) => {
                const dateParts = record.date.split('-');
                const formattedDate = dateParts.length === 3 
                  ? `${dateParts[1]}月${dateParts[2]}日` 
                  : record.date;

                const shortNumber = record.number && record.number.length >= 3 
                  ? record.number.slice(-3) 
                  : record.number;

                const tagPart = record.adminTag ? ` ${record.adminTag}` : '';
                const textToCopy = `${formattedDate}${shortNumber}號${record.subject}${tagPart}`;
                
                const ta = document.createElement("textarea");
                ta.value = textToCopy;
                document.body.appendChild(ta);
                ta.select();
                try {
                  document.execCommand('copy');
                  alert(`已複製簡化紀錄：\n${textToCopy}`);
                } catch (e) {
                  console.error('Copy failed', e);
                }
                document.body.removeChild(ta);
            };

            const handleSmartFill = async () => {
                if (!smartFillText.trim()) return;
                setIsAiLoading(true);
                const prompt = `請分析: "${smartFillText}"，回傳純JSON: {"date":"YYYY-MM-DD","author":"","code":"","number":"","subject":""}。`;
                const result = await callGemini(prompt);
                if (result) {
                  try {
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const pd = JSON.parse(cleanJson);
                    setFormData(prev => ({
                      ...prev,
                      date: pd.date || prev.date,
                      author: pd.author || prev.author,
                      code: pd.code || prev.code,
                      number: pd.number || prev.number,
                      subject: pd.subject || prev.subject,
                    }));
                    setShowSmartFillModal(false);
                    setSmartFillText("");
                    alert("AI 填寫完成");
                  } catch (e) {}
                }
                setIsAiLoading(false);
            };

            const handleAiRefine = async () => {
                if (!formData.subject) return;
                setIsAiLoading(true);
                const res = await callGemini(`將此文字改寫為正式公文主旨: "${formData.subject}"`);
                if (res) setFormData(prev => ({ ...prev, subject: res.trim() }));
                setIsAiLoading(false);
            };

            const saveAuthorDefault = async () => {
                if (!user) return;
                if (editingDefaultAuthor && tempDefaultCode) {
                    const newDefaults = { ...authorDefaults, [editingDefaultAuthor]: tempDefaultCode };
                    setAuthorDefaults(newDefaults);
                    
                    try {
                        const defaultsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'defaults');
                        await setDoc(defaultsRef, newDefaults, { merge: true });
                        alert(`已儲存 ${editingDefaultAuthor} 的預設文電代字：${tempDefaultCode}`);
                        setEditingDefaultAuthor(null);
                        setTempDefaultCode("");
                    } catch (e) {
                        console.error("Save defaults error", e);
                        alert("儲存失敗，請檢查網路");
                    }
                }
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 text-slate-500 gap-2">
                        <Loader2 className="animate-spin" /> 連線資料庫中...
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 relative overflow-hidden">
                    
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white transform transition-transform duration-300 shadow-2xl ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-5 flex justify-between items-center border-b border-slate-700">
                            <h2 className="font-bold flex items-center gap-2">{I('User')} 承辦人</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setIsSettingsMode(!isSettingsMode)} className={`p-1 rounded transition-colors ${isSettingsMode ? 'bg-amber-500' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>{I('Settings')}</button>
                                <button onClick={() => setIsSidebarOpen(false)} className="text-slate-400 hover:text-white">{I('X')}</button>
                            </div>
                        </div>
                        
                        {isSettingsMode && (
                             <div className="px-4 py-2 bg-amber-500/20 text-amber-200 text-xs text-center border-b border-amber-500/30">
                                 點擊下方人員以設定預設代字
                             </div>
                        )}

                        <div className="p-4 space-y-2">
                            {['所有', ...authorsList].map(officer => (
                                <button 
                                    key={officer} 
                                    onClick={() => { 
                                        if (isSettingsMode) {
                                            if (officer !== '所有') {
                                               setEditingDefaultAuthor(officer);
                                               setTempDefaultCode(authorDefaults[officer] || "");
                                            } else {
                                               alert("無法設定「所有」的預設值");
                                            }
                                        } else {
                                            setSelectedOfficer(officer); 
                                            setIsSidebarOpen(false); 
                                        }
                                    }} 
                                    className={`w-full text-left px-4 py-3 rounded-lg flex justify-between items-center ${
                                        isSettingsMode && officer !== '所有' ? 'hover:bg-amber-900/40 border border-transparent hover:border-amber-500/50' : 
                                        selectedOfficer === officer ? 'bg-blue-600' : 'hover:bg-slate-700'
                                    }`}
                                >
                                    <div className="flex items-center gap-2">
                                         <span>{officer}</span>
                                         {isSettingsMode && officer !== '所有' && authorDefaults[officer] && (
                                             <span className="text-[10px] bg-slate-900 px-1.5 rounded text-slate-300">{authorDefaults[officer]}</span>
                                         )}
                                    </div>
                                    {!isSettingsMode && selectedOfficer === officer && I('Check',{size:16})}
                                    {isSettingsMode && officer !== '所有' && I('Edit',{size:14, className:'opacity-50'})}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Overlay & Modals */}
                    {(isSidebarOpen || showSmartFillModal || editingDefaultAuthor) && (
                        <div className="fixed inset-0 bg-black/50 z-40" onClick={() => { setIsSidebarOpen(false); setShowSmartFillModal(false); setEditingDefaultAuthor(null); }} />
                    )}

                    {/* Default Settings Modal (Mini) */}
                    {editingDefaultAuthor && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
                             <div className="bg-white w-full max-w-xs rounded-xl p-5 shadow-2xl pointer-events-auto space-y-4">
                                 <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800">
                                     <Settings size={18} className="text-amber-500"/>
                                     設定預設值
                                 </h3>
                                 <div className="text-sm text-slate-600">
                                     請選擇 <strong>{editingDefaultAuthor}</strong> 發文時的預設文電代字：
                                 </div>
                                 <div className="relative">
                                    <input 
                                        list="codes-list-settings" 
                                        value={tempDefaultCode} 
                                        onChange={(e) => setTempDefaultCode(e.target.value)}
                                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                        placeholder="選擇或輸入代字"
                                    />
                                    <datalist id="codes-list-settings">{codesList.map(c=><option key={c} value={c}/>)}</datalist>
                                 </div>
                                 <div className="flex justify-end gap-2 pt-2">
                                     <button onClick={() => setEditingDefaultAuthor(null)} className="px-3 py-1.5 text-slate-500 hover:bg-slate-100 rounded">取消</button>
                                     <button onClick={saveAuthorDefault} className="px-3 py-1.5 bg-amber-500 text-white hover:bg-amber-600 rounded flex items-center gap-1">
                                         <Save size={16}/> 儲存
                                     </button>
                                 </div>
                             </div>
                        </div>
                    )}

                    {/* AI Modal */}
                    {showSmartFillModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                          <div className="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl space-y-4">
                             <div className="flex justify-between items-center border-b pb-3">
                               <h3 className="font-bold flex gap-2"><Sparkles className="text-purple-600"/> AI 智慧填表</h3>
                               <button onClick={() => setShowSmartFillModal(false)}><X/></button>
                             </div>
                             <textarea className="w-full h-32 p-3 border rounded-lg" placeholder="貼上文字..." value={smartFillText} onChange={e=>setSmartFillText(e.target.value)} />
                             <div className="flex justify-end gap-2">
                               <button onClick={handleSmartFill} disabled={isAiLoading} className="bg-purple-600 text-white px-4 py-2 rounded-lg flex gap-2">
                                 {isAiLoading ? <Loader2 className="animate-spin"/> : <Sparkles/>} 分析
                               </button>
                             </div>
                          </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">
                        <header className="bg-blue-700 text-white p-4 flex items-center gap-4 sticky top-0 z-30 shadow-md">
                          <button onClick={() => setIsSidebarOpen(true)}><Menu size={28}/></button>
                          <h1 className="text-xl font-bold">公文發文系統</h1>
                          <div className="ml-auto text-xs bg-blue-800 px-2 py-1 rounded flex items-center gap-1">
                             <Cloud size={12} className="text-blue-300"/> 
                             {selectedOfficer === '所有' ? '顯示全部' : selectedOfficer}
                          </div>
                        </header>

                        <div className="p-5 space-y-4 bg-slate-50 border-b border-slate-200">
                          <button onClick={() => setShowSmartFillModal(true)} className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-lg text-sm font-bold shadow-md flex justify-center gap-2">
                            <Sparkles size={16} /> AI 智慧填表 (Smart Fill)
                          </button>

                          {/* 表單核心區域 */}
                          <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                             {/* 裝飾線條 */}
                             <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                             
                             <div className="space-y-4 pl-2">
                                {/* Row 1: 日期 & 發文者 */}
                                <div className="grid grid-cols-2 gap-4">
                                  <div className="space-y-1">
                                    <div className="flex items-center h-6 mb-1">
                                      <label className="text-xs font-bold text-slate-500">發文日期</label>
                                    </div>
                                    <div className="relative">
                                      <input type="date" name="date" value={formData.date} onChange={handleInputChange} className="w-full p-2 pl-8 bg-slate-50 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                                      <Calendar className="absolute left-2 top-2.5 text-slate-400" size={14} />
                                    </div>
                                  </div>
                                  <div className="space-y-1">
                                    <div className="flex justify-between items-center h-6 mb-1">
                                      <label className="text-xs font-bold text-slate-500">發文者</label>
                                      <div className="flex gap-1">
                                         <button onClick={() => handleAddItem('author')} className="text-blue-600 hover:bg-blue-50 rounded p-0.5" title="新增"><Plus size={14}/></button>
                                         <button onClick={() => handleDeleteItem('author')} className="text-red-500 hover:bg-red-50 rounded p-0.5" title="刪除"><Trash2 size={14}/></button>
                                      </div>
                                    </div>
                                    <div className="relative">
                                      <input list="authors-list" name="author" value={formData.author} onChange={handleInputChange} className="w-full p-2 pl-8 bg-slate-50 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="選擇人員" />
                                      <User className="absolute left-2 top-2.5 text-slate-400" size={14} />
                                      <datalist id="authors-list">{authorsList.map(a=><option key={a} value={a}/>)}</datalist>
                                    </div>
                                  </div>
                                </div>

                                {/* Row 2: 文電代字 & 字號 */}
                                <div className="grid grid-cols-2 gap-4">
                                  <div className="space-y-1">
                                    <div className="flex justify-between items-center h-6 mb-1">
                                      <label className="text-xs font-bold text-slate-500">文電代字</label>
                                      <div className="flex gap-1">
                                         <button onClick={() => handleAddItem('code')} className="text-blue-600 hover:bg-blue-50 rounded p-0.5" title="新增"><Plus size={14}/></button>
                                         <button onClick={() => handleDeleteItem('code')} className="text-red-500 hover:bg-red-50 rounded p-0.5" title="刪除"><Trash2 size={14}/></button>
                                      </div>
                                    </div>
                                    <div className="relative">
                                       <input list="codes-list" name="code" value={formData.code} onChange={handleInputChange} className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="選擇代字" />
                                       <datalist id="codes-list">{codesList.map(c=><option key={c} value={c}/>)}</datalist>
                                       <ChevronDown className="absolute right-2 top-3 text-slate-400 pointer-events-none" size={12} />
                                    </div>
                                  </div>
                                  <div className="space-y-1">
                                    <div className="flex items-center h-6 mb-1">
                                      <label className="text-xs font-bold text-slate-500">字號 <span className="text-[10px] font-normal text-slate-400 ml-1">(留空自動生成)</span></label>
                                    </div>
                                    <input type="text" name="number" value={formData.number} onChange={handleInputChange} className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="輸入字號" />
                                  </div>
                                </div>
                             </div>
                          </div>

                          {/* 第二層行政類別 */}
                          <div className="bg-slate-50 rounded-xl p-4 border border-slate-200 shadow-sm mt-4">
                             <div className="flex items-center gap-2 mb-3">
                                <Briefcase size={16} className="text-blue-600" /> 
                                <span className="text-sm font-bold text-slate-700">第二層：行政類別 (令號)</span>
                             </div>
                             <div className="bg-white p-1 rounded-lg border border-slate-200 flex mb-3 shadow-sm">
                               {Object.entries(ADMIN_TYPES).map(([key, cfg]) => {
                                 const Icon = cfg.icon;
                                 return <button key={key} onClick={() => handleAdminTypeChange(key)} className={`flex-1 py-2 text-xs rounded-md flex justify-center gap-1 transition-all ${adminType===key?'bg-blue-50 text-blue-700 font-bold border border-blue-100':'text-slate-500 hover:bg-slate-50'}`}><Icon size={14}/>{cfg.label}</button>
                               })}
                             </div>
                             {adminType !== 'general' && (
                               <div className="bg-white p-4 rounded-lg border border-blue-100 flex flex-col gap-3 animate-fadeIn shadow-sm">
                                 <div className="flex items-center gap-3">
                                   <span className="text-sm font-bold text-blue-700 w-12 text-right">身分:</span>
                                   <div className="flex-1 flex gap-2">
                                     {RANKS.map(r => <button key={r.id} onClick={()=>setSelectedRank(r.id)} className={`flex-1 py-1.5 text-xs rounded border transition-colors ${selectedRank===r.id?'bg-blue-600 text-white border-blue-600':'bg-white border-slate-200 text-slate-600 hover:border-blue-300'}`}>{r.label}</button>)}
                                   </div>
                                 </div>
                                 <div className="flex items-center gap-3">
                                   <span className="text-sm font-bold text-blue-700 w-12 text-right">令號:</span>
                                   <div className="flex-1 flex items-center bg-slate-50 border border-slate-300 rounded px-3 py-1.5">
                                      <span className="text-sm font-bold text-slate-600 mr-2">{ADMIN_TYPES[adminType].prefix}</span>
                                      <input type="text" value={adminNumber} onChange={e=>setAdminNumber(e.target.value)} className="flex-1 bg-transparent text-sm outline-none font-bold text-blue-800" placeholder="留空自動生成" />
                                      <span className="text-sm text-slate-500">號</span>
                                   </div>
                                 </div>
                                 {/* 預覽 */}
                                 {selectedRank && <div className="text-right text-[10px] text-blue-400 font-mono mt-1">預覽: {getAdminTagPreview()}</div>}
                               </div>
                             )}
                          </div>

                          {/* 主旨 */}
                          <div className="space-y-1">
                            <div className="flex justify-between items-center">
                              <label className="text-xs font-bold text-slate-500">主旨</label>
                              <button onClick={handleAiRefine} disabled={isAiLoading||!formData.subject} className="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded flex items-center gap-1"><Sparkles size={10}/> AI 潤飾</button>
                            </div>
                            <textarea name="subject" rows="3" value={formData.subject} onChange={handleInputChange} className="w-full p-3 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="輸入公文主旨..." />
                          </div>

                          {/* Action Buttons */}
                          <div className="grid grid-cols-3 gap-3">
                             <button onClick={handleSearch} className="flex items-center justify-center gap-1 py-2 rounded-lg border border-blue-600 text-blue-600 text-sm font-medium hover:bg-blue-50"><Search size={16}/> 查詢</button>
                             <button onClick={handleUpdate} className={`flex items-center justify-center gap-1 py-2 rounded-lg border text-sm font-medium ${formData.id ? 'bg-amber-50 border-amber-400 text-amber-700' : 'bg-slate-50 border-slate-200 text-slate-300'}`}><Edit size={16}/> 更改</button>
                             <button onClick={handleRegister} className="flex items-center justify-center gap-1 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 shadow-md"><Plus size={16}/> 登錄</button>
                          </div>
                        </div>

                        {/* Records List Area */}
                        <div className="flex-1 bg-slate-100 p-4">
                          <div className="flex flex-col gap-2 mb-3">
                             <div className="flex justify-between items-center">
                                <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2"><ClipboardList size={18}/> 發文紀錄 <span className="text-xs font-normal text-slate-400">({displayRecords.length})</span></h3>
                                
                                {/* 排序與展開工具列 */}
                                <div className="flex gap-2">
                                   <button 
                                     onClick={() => setSortOrder(prev => prev === 'newest' ? 'oldest' : 'newest')}
                                     className="flex items-center gap-1 text-[11px] bg-white border border-slate-200 px-2 py-1 rounded text-slate-600 hover:bg-slate-50"
                                   >
                                     <ArrowDownUp size={12} />
                                     {sortOrder === 'newest' ? '字號大→小' : '字號小→大'}
                                   </button>
                                   <button 
                                     onClick={() => setIsListExpanded(prev => !prev)}
                                     className="flex items-center gap-1 text-[11px] bg-white border border-slate-200 px-2 py-1 rounded text-slate-600 hover:bg-slate-50"
                                   >
                                     {isListExpanded ? <Minimize2 size={12} /> : <Maximize2 size={12} />}
                                     {isListExpanded ? '收合' : '全展開'}
                                   </button>
                                </div>
                             </div>
                             
                             {searchMode && <div className="text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded border flex justify-between items-center">
                               <span>搜尋: "{searchQuery}"</span>
                               <button onClick={() => {setSearchMode(false); setSearchQuery("");}} className="underline">清除</button>
                             </div>}
                          </div>

                          <div className="space-y-3 pb-10">
                            {displayRecords.map((record) => (
                              <div 
                                key={record.id} 
                                onClick={() => handleEditLoad(record)} 
                                className={`bg-white rounded-xl p-3 shadow-sm border hover:shadow-md relative group cursor-pointer transition-all ${formData.id === record.id ? 'ring-2 ring-amber-400 border-amber-400' : 'border-slate-200'}`}
                              >
                                <button onClick={(e) => { e.stopPropagation(); handleCopy(record); }} className="absolute top-2 right-2 p-1.5 text-slate-300 hover:text-blue-600 hover:bg-blue-50 rounded"><Copy size={16} /></button>
                                
                                {/* 標頭資訊 */}
                                <div className="flex flex-wrap gap-2 text-[11px] font-mono text-slate-500 mb-2 pr-8">
                                  <span className="bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">{record.date}</span>
                                  <span className="bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200 text-slate-700 font-bold">{record.code}</span>
                                  <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-100 font-bold">{record.number}</span>
                                  <span>{record.author}</span>
                                </div>

                                {/* 主旨與標籤 */}
                                <div className={`text-sm text-slate-800 ${isListExpanded ? '' : 'line-clamp-2'} leading-relaxed`}>
                                    {record.subject}
                                </div>
                                
                                {/* 行政標籤 (若有) */}
                                {record.adminTag && (
                                   <div className="mt-2 flex">
                                     <span className="bg-purple-50 text-purple-700 text-[10px] px-2 py-0.5 rounded border border-purple-100 font-bold flex items-center gap-1">
                                        <Tag size={10} /> {record.adminTag}
                                     </span>
                                   </div>
                                )}
                              </div>
                            ))}
                            {displayRecords.length === 0 && <div className="text-center py-8 text-slate-400 text-xs">目前無資料，請登錄第一筆公文</div>}
                          </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>