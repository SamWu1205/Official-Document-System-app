<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>æ¥­å‹™ç®¡ç†ç³»çµ±</title>
  <link rel="icon" href="./logo.jpg" />
  <link rel="apple-touch-icon" href="./logo.jpg" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); overscroll-behavior-y: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .input-ios { height: 48px; width: 100%; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; padding: 0 12px; appearance: none; }
    .input-ios:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
    .sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); } .sidebar-closed { transform: translateX(-100%); } .sidebar-open { transform: translateX(0); }
    .overlay { transition: opacity 0.3s ease; }
    .bg-dot-pattern { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
    
    /* ğŸ”” éˆ´éºå‹•ç•« */
    @keyframes bellShake { 0% { transform: rotate(0); } 15% { transform: rotate(15deg); } 30% { transform: rotate(-15deg); } 45% { transform: rotate(10deg); } 60% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 85% { transform: rotate(-5deg); } 100% { transform: rotate(0); } }
    .animate-bell { animation: bellShake 1s infinite; }
    
    /* æ»‘å‹•èˆ‡æ‹–æ›³ */
    .card-content { transition: transform 0.1s ease-out; }
    .sortable-ghost { opacity: 0.5; background: #f1f5f9; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.firebasestorage.app",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
      measurementId: "G-B9R46YLGXQ"
    };
    const APP_ID = "dispatch-system-pro-v1";

    try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const { useState, useEffect, useMemo, useRef } = React;

    // --- å·¥å…·å‡½å¼ ---
    const formatDateNoYear = (d) => { if(!d)return""; const p=d.split('-'); return p.length<3?d:`${parseInt(p[1])}æœˆ${parseInt(p[2])}æ—¥`; };
    const formatDateTime = (iso) => { if(!iso)return""; const d=new Date(iso); return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };
    const getNowISO = () => { const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); };
    
    // å‰©é¤˜æ™‚é–“è¨ˆç®—
    const getRemainingText = (endStr) => {
        if(!endStr) return null;
        const diff = new Date(endStr) - new Date();
        if(diff < 0) return "å·²éæœŸ";
        const days = Math.floor(diff/86400000);
        if(days > 0) return `å‰© ${days} å¤©`;
        const hrs = Math.floor(diff/3600000);
        const mins = Math.floor((diff%3600000)/60000);
        return `å‰© ${hrs}æ™‚${mins}åˆ†`;
    };

    // åœ–ç‰‡å£“ç¸®
    const compressImage = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                let w=img.width, h=img.height;
                if(w>800) { h=(800/w)*h; w=800; }
                cvs.width=w; cvs.height=h;
                cvs.getContext('2d').drawImage(img,0,0,w,h);
                resolve(cvs.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });

    // --- 1. å¡ç‰‡å…ƒä»¶ (åŒ…å«å·¦æ»‘èˆ‡æ‹–æ›³) ---
    const TaskItem = ({ t, onClick, onComplete, onDelete, onDragStart, onDragOver, onDrop, draggable }) => {
        const [swipeX, setSwipeX] = useState(0);
        const touchX = useRef(null);

        // æé†’é‚è¼¯
        const diff = new Date(t.endDate) - new Date();
        const isExpired = diff < 0;
        const remindMs = parseInt(t.reminderMinutes||0) * 60000;
        // æ¢ä»¶ï¼š(æœ‰è¨­æé†’ ä¸” æ™‚é–“åˆ°äº†) æˆ– (å·²éæœŸ)
        const showBell = (remindMs > 0 && diff > 0 && diff <= remindMs) || isExpired;
        const isDone = t.status === 'completed';
        const color = t.priority==='æ€¥ä»¶'?'bg-red-500':t.priority==='ä¸€èˆ¬'?'bg-emerald-500':'bg-purple-500';

        // æ‰‹å‹¢
        const tStart = (e) => { if(!isDone) touchX.current = e.touches[0].clientX; };
        const tMove = (e) => {
            if(!touchX.current || isDone) return;
            const d = e.touches[0].clientX - touchX.current;
            if(d < 0 && d > -120) setSwipeX(d); // åªèƒ½å·¦æ»‘
        };
        const tEnd = () => {
            if(swipeX < -80 && confirm("ç¢ºå®šè¾¦çµï¼Ÿ")) onComplete(t.id);
            setSwipeX(0); touchX.current = null;
        };

        return (
            <div className={`relative mb-3 rounded-2xl overflow-hidden shadow-sm border border-slate-100 ${isDone?'opacity-60 grayscale bg-slate-50':'bg-white'}`}
                 draggable={draggable} onDragStart={onDragStart} onDragOver={onDragOver} onDrop={onDrop}>
                {/* èƒŒæ™¯è¾¦çµæŒ‰éˆ• */}
                <div className="absolute inset-0 bg-blue-500 flex items-center justify-end pr-6 rounded-2xl">
                    <span className="text-white font-bold"><i className="fas fa-check"></i> è¾¦çµ</span>
                </div>
                {/* å‰æ™¯å…§å®¹ */}
                <div className="relative bg-white p-4 card-content" style={{transform: `translateX(${swipeX}px)`}}
                     onTouchStart={tStart} onTouchMove={tMove} onTouchEnd={tEnd} onClick={onClick}>
                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${color}`}></div>
                    <div className="flex justify-between items-start pl-3">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                                <h3 className={`font-bold text-lg ${isDone?'line-through text-slate-400':'text-slate-800'}`}>{t.title}</h3>
                                {t.imageUrl && <i className="fas fa-image text-slate-400"></i>}
                            </div>
                            <div className="text-xs text-slate-500">
                                <div>å§”è¨—ï¼š{t.delegator||"æœªè¨­å®š"} | {t.type}</div>
                                <div><i className="far fa-clock"></i> {formatDateTime(t.startDate)} â†’ {formatDateTime(t.endDate)}</div>
                            </div>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                            {!isDone && getRemainingText(t.endDate) && (
                                <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded whitespace-nowrap ${isExpired?'bg-red-100 text-red-600':showBell?'bg-red-50 text-red-600':'bg-slate-100 text-slate-600'}`}>
                                    {showBell && <i className="fas fa-bell animate-bell"></i>}
                                    {getRemainingText(t.endDate)}
                                </div>
                            )}
                            {isDone && <span className="text-xs bg-slate-200 text-slate-500 px-2 py-1 rounded font-bold">å·²è¾¦çµ</span>}
                            <div className="flex gap-2 mt-1">
                                {!isDone && <button onClick={(e)=>{e.stopPropagation();onComplete(t.id)}} className="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i className="fas fa-check"></i></button>}
                                <button onClick={(e)=>{e.stopPropagation();onDelete(t.id)}} className="w-8 h-8 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center"><i className="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- 2. ç™»å…¥ç•«é¢ ---
    const LoginScreen = () => {
        const [isReg, setIsReg] = useState(false);
        const [form, setForm] = useState({email:'', pwd:''});
        const [err, setErr] = useState("");
        const [loading, setLoading] = useState(false);

        const go = async (e) => {
            e.preventDefault(); setErr(""); setLoading(true);
            try {
                if(isReg) await auth.createUserWithEmailAndPassword(form.email, form.pwd);
                else await auth.signInWithEmailAndPassword(form.email, form.pwd);
            } catch(e) { setErr(e.message); } finally { setLoading(false); }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white w-full max-w-sm p-8 rounded-2xl shadow-xl text-center">
                    <div className="mb-6"><img src="./logo.jpg" className="w-24 h-24 mx-auto rounded-3xl shadow border-2"/></div>
                    <h1 className="text-2xl font-bold text-slate-800 mb-6">æ¥­å‹™ç®¡ç†ç³»çµ±</h1>
                    <form onSubmit={go} className="space-y-4">
                        <input type="email" required className="input-ios" placeholder="Email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} />
                        <input type="password" required className="input-ios" placeholder="å¯†ç¢¼" value={form.pwd} onChange={e=>setForm({...form,pwd:e.target.value})} />
                        {err && <div className="text-red-500 text-sm">{err}</div>}
                        <button disabled={loading} className="w-full bg-slate-900 text-white h-12 rounded-xl font-bold shadow">{loading?"è™•ç†ä¸­...":isReg?"è¨»å†Š":"ç™»å…¥"}</button>
                    </form>
                    <div className="mt-4 text-sm text-blue-600 cursor-pointer" onClick={()=>setIsReg(!isReg)}>{isReg?"è¿”å›ç™»å…¥":"è¨»å†Šå¸³è™Ÿ"}</div>
                </div>
            </div>
        );
    };

    // --- 3. ä¸»ç¨‹å¼ ---
    function App() {
        const [user, setUser] = useState(null);
        const [view, setView] = useState("home");
        const [menu, setMenu] = useState(false);
        const [recs, setRecs] = useState([]);
        const [tasks, setTasks] = useState([]);
        const [meta, setMeta] = useState({authors:[], codes:[], taskTypes:[]});
        const [form, setForm] = useState({id:null, date:getNowISO().split('T')[0], author:"", code:"", number:"", subject:"", docType:"ä¸€èˆ¬å…¬æ–‡", rank:"è»å®˜", subNumber:""});
        const [isManual, setIsManual] = useState(false);
        const [filter, setFilter] = useState({type:'all', val:''});
        
        // å·¥ä½œç®¡åˆ¶ç‹€æ…‹
        const [taskModal, setTaskModal] = useState(false);
        const [taskForm, setTaskForm] = useState({});
        const [taskFilter, setTaskFilter] = useState("å…¨éƒ¨");
        const [taskSearch, setTaskSearch] = useState("");
        const dragItem = useRef();
        const dragOverItem = useRef();

        // ç³»çµ±è¨­å®šç‹€æ…‹
        const [newAuth, setNewAuth] = useState("");
        const [newType, setNewType] = useState("");
        const [editDef, setEditDef] = useState(null);

        const fileRef = useRef(); // Excel input
        const imgRef = useRef();  // Image input

        useEffect(() => auth.onAuthStateChanged(u => setUser(u)), []);

        useEffect(() => {
            if(!user) return;
            const ref = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid);
            
            // ç›£è½å…¬æ–‡
            ref.collection("records").orderBy("createdAt","desc").limit(200).onSnapshot(s => 
                setRecs(s.docs.map(d=>({id:d.id, ...d.data()})))
            );
            // ç›£è½å·¥ä½œ (ä¸ä½¿ç”¨ orderBy('order') ä»¥å…èˆŠè³‡æ–™æ¶ˆå¤±ï¼Œæ”¹å‰ç«¯æ’)
            ref.collection("tasks").orderBy("createdAt","desc").onSnapshot(s => 
                setTasks(s.docs.map(d=>({id:d.id, ...d.data()})))
            );
            // ç›£è½è¨­å®š
            ref.collection("metadata").doc("general").onSnapshot(d => {
                if(d.exists) setMeta({...d.data(), taskTypes: d.data().taskTypes||['è¡Œæ”¿','è¨“ç·´','å¾Œå‹¤','äººäº‹','ä¿é¤Š','äº¤è¾¦','å…¶ä»–']});
                else ref.collection("metadata").doc("general").set({authors:[], codes:[], taskTypes:['è¡Œæ”¿']});
            });
        }, [user]);

        // --- å…¬æ–‡é‚è¼¯ ---
        const nextNum = useMemo(() => {
            const yr = String(new Date().getFullYear()-1911);
            const nums = recs.map(r=>r.number).filter(n=>n&&n.startsWith(yr)).map(n=>parseInt(n)).filter(n=>!isNaN(n));
            const main = nums.length ? String(Math.max(...nums)+1) : yr+"0000001";
            const getSub = (type, rank) => {
                if(type==="ä¸€èˆ¬å…¬æ–‡") return "";
                const subs = recs.filter(r=>r.docType===type && r.rank===rank && r.subNumber).map(r=>parseInt(r.subNumber)).filter(n=>!isNaN(n));
                return subs.length ? String(Math.max(...subs)+1).padStart(3,'0') : "001";
            };
            return { main, getSub };
        }, [recs]);

        useEffect(() => {
            if(!form.id && !isManual) setForm(p=>({...p, number: nextNum.main, subNumber: nextNum.getSub(form.docType, form.rank)}));
        }, [recs, form.docType, form.rank, form.id, isManual, nextNum]);

        const saveRec = async () => {
            if(!form.subject) return alert("è«‹è¼¸å…¥ä¸»æ—¨");
            const ref = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid);
            const pl = {...form, updatedAt: new Date().toISOString()};
            delete pl.id;
            if(!form.id) { pl.createdAt = new Date().toISOString(); await ref.collection("records").add(pl); }
            else await ref.collection("records").doc(form.id).set(pl, {merge:true});
            
            if(form.author) ref.collection("metadata").doc("general").set({authors:firebase.firestore.FieldValue.arrayUnion(form.author), codes:firebase.firestore.FieldValue.arrayUnion(form.code)},{merge:true});
            setForm({id:null, date:form.date, author:form.author, code:form.code, number:"", subject:"", docType:"ä¸€èˆ¬å…¬æ–‡", rank:"è»å®˜", subNumber:""});
            setIsManual(false); window.scrollTo(0,0);
        };

        // --- å·¥ä½œé‚è¼¯ ---
        const openTask = (t) => {
            setTaskForm(t ? {...t, reminderMinutes: t.reminderMinutes||"0", imageUrl: t.imageUrl||""} : {id:null, title:"", type:"è¡Œæ”¿", delegator:"", priority:"ä¸€èˆ¬", startDate:getNowISO(), endDate:getNowISO(), notes:"", reminderMinutes:"0", status:"active", order: Date.now()});
            setTaskModal(true);
        };

        const saveTask = async () => {
            if(!taskForm.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
            const ref = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks");
            const pl = {...taskForm, updatedAt: new Date().toISOString()};
            const id = pl.id; delete pl.id;
            if(id) await ref.doc(id).update(pl);
            else { pl.createdAt = new Date().toISOString(); pl.order = Date.now(); await ref.add(pl); }
            setTaskModal(false);
        };

        // æ‹–æ›³æ’åº
        const onDrop = async () => {
            if(!dragItem.current || !dragOverItem.current) return;
            const cp = [...filTasks];
            const item = cp.splice(dragItem.current, 1)[0];
            cp.splice(dragOverItem.current, 0, item);
            
            const batch = db.batch();
            const ref = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks");
            cp.forEach((t, i) => { if(t.id) batch.update(ref.doc(t.id), {order: i}); });
            await batch.commit();
            dragItem.current = null; dragOverItem.current = null;
        };

        const filTasks = useMemo(() => {
            let res = [...tasks];
            if(taskFilter!=="å…¨éƒ¨") res = res.filter(t=>t.priority===taskFilter);
            if(taskSearch) res = res.filter(t=>t.title.includes(taskSearch));
            res.sort((a,b) => {
                if(a.status==='completed' && b.status!=='completed') return 1;
                if(a.status!=='completed' && b.status==='completed') return -1;
                const oa = a.order === undefined ? -1 : a.order;
                const ob = b.order === undefined ? -1 : b.order;
                return oa - ob;
            });
            return res;
        }, [tasks, taskFilter, taskSearch]);

        // Excel Export/Import
        const doExport = () => {
            if(!recs.length && !tasks.length) return alert("ç„¡è³‡æ–™");
            const wb = XLSX.utils.book_new();
            if(recs.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(recs.map(r=>({"ç¸½è™Ÿ":r.number,"æ—¥æœŸ":r.date,"ç™¼æ–‡è€…":r.author,"ä»£å­—":r.code,"ä¸»æ—¨":r.subject,"åˆ†è™Ÿ":r.subNumber||"","ç¨®é¡":r.docType,"éšç´š":r.rank}))), "å…¬æ–‡");
            if(tasks.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tasks.map(t=>({"æ¨™é¡Œ":t.title,"ç¨®é¡":t.type,"å§”è¨—":t.delegator,"é‡è¦":t.priority,"é–‹å§‹":t.startDate,"çµæŸ":t.endDate,"å‚™è¨»":t.notes}))), "å·¥ä½œ");
            XLSX.writeFile(wb, "Backup.xlsx");
        };

        const doImport = (e) => {
            const f = e.target.files[0]; if(!f) return;
            if(!confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿ")) return;
            const r = new FileReader();
            r.onload = async (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const ref = db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid);
                    const rs = wb.Sheets["å…¬æ–‡"]||wb.Sheets["å…¬æ–‡ç´€éŒ„"];
                    if(rs) XLSX.utils.sheet_to_json(rs).forEach(r=>ref.collection("records").add({number:String(r["ç¸½è™Ÿ"]), date:r["æ—¥æœŸ"], author:r["ç™¼æ–‡è€…"], code:r["ä»£å­—"], subject:r["ä¸»æ—¨"], subNumber:String(r["åˆ†è™Ÿ"]||""), docType:r["ç¨®é¡"], rank:r["éšç´š"], createdAt:new Date().toISOString()}));
                    const ts = wb.Sheets["å·¥ä½œ"]||wb.Sheets["å·¥ä½œç®¡åˆ¶"];
                    if(ts) XLSX.utils.sheet_to_json(ts).forEach(t=>ref.collection("tasks").add({title:t["æ¨™é¡Œ"], type:t["ç¨®é¡"], delegator:t["å§”è¨—"], priority:t["é‡è¦"], startDate:t["é–‹å§‹"], endDate:t["çµæŸ"], notes:t["å‚™è¨»"], status:"active", order:Date.now(), createdAt:new Date().toISOString()}));
                    alert("å®Œæˆ"); window.location.reload();
                } catch(err){ alert("å¤±æ•—"); }
            };
            r.readAsBinaryString(f);
        };

        if(!user) return <LoginScreen />;

        return (
            <div className="min-h-screen flex flex-col bg-slate-50 pb-20 bg-dot-pattern">
                {menu && <div className="fixed inset-0 bg-black/30 z-40 backdrop-blur-sm" onClick={()=>setMenu(false)}/>}
                <div className={`fixed inset-y-0 left-0 w-[280px] bg-white shadow-2xl z-50 sidebar ${menu?'sidebar-open':'sidebar-closed'} flex flex-col`}>
                    <div className="bg-slate-900 text-white p-6 pt-12"><h2 className="font-bold text-xl">åŠŸèƒ½é¸å–®</h2><div className="text-xs opacity-70">{user.email}</div></div>
                    <div className="flex-1 p-4 space-y-2">
                        {[{k:'home',n:'é¦–é ',i:'pen-nib'},{k:'docs',n:'å…¬æ–‡ç³»çµ±',i:'folder-open'},{k:'tasks',n:'å·¥ä½œç®¡åˆ¶',i:'tasks'},{k:'personnel',n:'ç³»çµ±è¨­å®š',i:'cogs'}].map(x=>(
                            <button key={x.k} onClick={()=>{setView(x.k);setMenu(false)}} className={`w-full text-left p-3 rounded-xl font-bold flex gap-3 ${view===x.k?'bg-blue-50 text-blue-600':'text-slate-600 hover:bg-slate-50'}`}>
                                <i className={`fas fa-${x.i} w-6 text-center`}></i> {x.n}
                            </button>
                        ))}
                        <hr className="my-2"/>
                        <button onClick={doExport} className="w-full text-left p-3 text-slate-600 font-bold"><i className="fas fa-file-export mr-3"></i> åŒ¯å‡º Excel</button>
                        <div className="relative"><input type="file" ref={fileRef} onChange={doImport} className="hidden"/><button onClick={()=>fileRef.current.click()} className="w-full text-left p-3 text-slate-600 font-bold"><i className="fas fa-file-import mr-3"></i> åŒ¯å…¥ Excel</button></div>
                        <button onClick={()=>auth.signOut()} className="w-full text-left p-3 text-red-500 font-bold"><i className="fas fa-sign-out-alt mr-3"></i> ç™»å‡º</button>
                    </div>
                </div>

                <header className="sticky top-0 bg-white/90 backdrop-blur border-b h-14 flex items-center px-4 justify-between z-30">
                    <div className="flex items-center gap-4"><button onClick={()=>setMenu(true)}><i className="fas fa-bars text-xl text-slate-700"></i></button><h1 className="font-bold text-lg text-slate-800">{view==='home'?'å¡«å¯«è¡¨å–®':view==='docs'?'å…¬æ–‡ç³»çµ±':view==='tasks'?'å·¥ä½œç®¡åˆ¶':'ç³»çµ±è¨­å®š'}</h1></div>
                    {view==='home' && <button onClick={()=>{setForm({id:null,date:form.date,author:form.author,code:form.code,number:"",subject:"",docType:"ä¸€èˆ¬å…¬æ–‡",rank:"è»å®˜",subNumber:""});setIsManual(false)}} className="text-sm text-slate-500">é‡ç½®</button>}
                </header>

                <main className="flex-1 p-4 max-w-md mx-auto w-full fade-in">
                    {/* 1. è¡¨å–® */}
                    {view==='home' && (
                        <div className="space-y-4">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500">æ—¥æœŸ</label><input type="date" className="input-ios" value={form.date} onChange={e=>setForm({...form,date:e.target.value})}/></div>
                                    <div><label className="text-xs font-bold text-slate-500">ç™¼æ–‡è€…</label><input list="alist" className="input-ios" value={form.author} onChange={e=>{setForm({...form,author:e.target.value});if(meta.authorDefaults?.[e.target.value])setForm(p=>({...p,code:meta.authorDefaults[e.target.value]}))}} placeholder="é¸æ“‡"/><datalist id="alist">{meta.authors.map(a=><option key={a} value={a}/>)}</datalist></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500">ä»£å­—</label><input list="clist" className="input-ios" value={form.code} onChange={e=>setForm({...form,code:e.target.value})}/><datalist id="clist">{meta.codes.map(c=><option key={c} value={c}/>)}</datalist></div>
                                    <div className="grid grid-cols-3 gap-1">
                                        <div className="col-span-2 relative"><label className="text-xs font-bold text-slate-500">ç¸½è™Ÿ</label><input type="text" className="input-ios text-right pr-8" readOnly={!isManual} value={form.number} onChange={e=>setForm({...form,number:e.target.value})}/><i onClick={()=>setIsManual(!isManual)} className={`fas fa-lock${isManual?'-open':''} absolute right-2 top-6 text-slate-400`}></i></div>
                                        <div><label className="text-xs font-bold text-slate-500">åˆ†è™Ÿ</label><input type="text" className="input-ios text-center" value={form.subNumber} onChange={e=>setForm({...form,subNumber:e.target.value})}/></div>
                                    </div>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500">ä¸»æ—¨</label><textarea className="w-full border rounded-xl p-3 h-20" value={form.subject} onChange={e=>setForm({...form,subject:e.target.value})}></textarea></div>
                                <div className="flex gap-2 overflow-x-auto pb-1">{['ä¸€èˆ¬å…¬æ–‡','äººå‹¤ä»¤','äººè·ä»¤'].map(t=><button key={t} onClick={()=>setForm({...form,docType:t})} className={`flex-1 py-2 text-xs rounded-lg font-bold whitespace-nowrap ${form.docType===t?'bg-white text-blue-600 shadow-sm':'text-slate-400'}`}>{t}</button>)}</div>
                                {form.docType!=='ä¸€èˆ¬å…¬æ–‡' && <div className="flex gap-2 pb-1">{['è»å®˜','å£«å®˜','å£«å…µ'].map(r=><button key={r} onClick={()=>setForm({...form,rank:r})} className={`flex-1 py-2 text-xs rounded-lg font-bold ${form.rank===r?'bg-indigo-600 text-white':'text-slate-400'}`}>{r}</button>)}</div>}
                                <div className="grid grid-cols-4 gap-2">
                                    <button onClick={()=>{const k=prompt("é—œéµå­—");if(k)setFilter({type:'search',val:k})}} className="col-span-1 rounded-xl border font-bold text-slate-600">æŸ¥è©¢</button>
                                    <button onClick={()=>{setIsManual(true);handleSubmit(false)}} disabled={!form.id} className="col-span-1 rounded-xl border font-bold text-blue-600 disabled:text-slate-300">ä¿®æ”¹</button>
                                    <button onClick={()=>handleSubmit(true)} className="col-span-2 bg-slate-900 text-white h-12 rounded-xl font-bold shadow-lg">ç™»éŒ„</button>
                                </div>
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-800 mb-2 px-2">{filter.type==='search'?`æœå°‹: ${filter.val}`:'æœ€è¿‘ç´€éŒ„'} {filter.type==='search'&&<span onClick={()=>setFilter({type:'all'})} className="text-blue-500 text-xs ml-2">æ¸…é™¤</span>}</h3>
                                {displayRecords.slice(0,20).map(r=>(
                                    <div key={r.id} onClick={()=>{setForm({...r});setIsManual(true);window.scrollTo(0,0)}} className="bg-white p-4 mb-2 rounded-2xl border border-slate-100 shadow-sm">
                                        <div className="flex justify-between font-mono font-bold text-blue-600"><span>#{r.number}</span><span className="text-xs text-slate-400 font-sans">{formatDateNoYear(r.date)}</span></div>
                                        <div className="font-bold text-slate-800 my-1 line-clamp-1">{r.subject}</div>
                                        <div className="text-xs text-slate-500"><span className="bg-slate-100 px-2 py-1 rounded">{r.author}</span> {r.docType!=='ä¸€èˆ¬å…¬æ–‡'&&<span className="bg-indigo-50 text-indigo-600 px-2 py-1 rounded">{r.docType} {r.subNumber}</span>}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* 2. å…¬æ–‡ç³»çµ± */}
                    {view==='docs' && (
                        <div className="space-y-4">
                            <div className="flex bg-slate-200 p-1 rounded-xl">{['äººå‹¤ä»¤','äººè·ä»¤'].map(t=><button key={t} onClick={()=>setDocTab(t)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${docTab===t?'bg-white text-blue-600 shadow-sm':'text-slate-500'}`}>{t}</button>)}</div>
                            {docSystemRecords.map(r=>(
                                <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-start">
                                    <div><div className="text-xs text-slate-400 mb-1">{formatDateNoYear(r.date)}</div><div className="font-bold text-lg mb-1">{r.subject}</div><div className="text-sm bg-slate-100 px-2 py-0.5 rounded inline-block">{r.author} ({r.rank})</div></div>
                                    <div className="text-right pl-2"><div className="text-[10px] text-slate-400">åˆ†è™Ÿ</div>{editingSubNumId===r.id?(<div className="flex gap-1"><input className="w-16 border rounded text-center" value={editingSubNumVal} onChange={e=>setEditingSubNumVal(e.target.value)} autoFocus /><button onClick={saveSubNumber} className="text-green-500"><i className="fas fa-check"></i></button></div>):(<div onClick={()=>{setEditingSubNumId(r.id);setEditingSubNumVal(r.subNumber||"")}} className="font-mono font-bold text-2xl text-blue-900 border-b border-transparent hover:border-blue-300">{r.subNumber}</div>)}</div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* 3. å·¥ä½œç®¡åˆ¶ */}
                    {view==='tasks' && (
                        <div className="space-y-4">
                            <div className="bg-white p-2 rounded-xl shadow-sm space-y-2">
                                <div className="relative"><i className="fas fa-search absolute left-3 top-3 text-slate-400"></i><input className="w-full bg-slate-100 rounded-xl pl-9 pr-4 py-2 outline-none" placeholder="æœå°‹..." value={taskSearch} onChange={e=>setTaskSearch(e.target.value)}/></div>
                                <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">{['å…¨éƒ¨','æ€¥ä»¶','ä¸€èˆ¬','äº¤è¾¦'].map(f=><button key={f} onClick={()=>setTaskFilter(f)} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${taskFilter===f?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'}`}>{f}</button>)}</div>
                            </div>
                            <div className="pb-20">
                                {filTasks.map((t,i)=>(
                                    <TaskItem key={t.id} t={t} onClick={()=>openTask(t)} onComplete={(id)=>db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks").doc(id).update({status:'completed'})} onDelete={(id)=>confirm("åˆªé™¤?")&&db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("tasks").doc(id).delete()}
                                        draggable={taskFilter==='å…¨éƒ¨'&&!taskSearch&&t.status!=='completed'} onDragStart={()=>(dragItem.current=i)} onDragOver={(e)=>{e.preventDefault();dragOverItem.current=i}} onDrop={onDrop}
                                    />
                                ))}
                            </div>
                            <button onClick={()=>openTask(null)} className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl"><i className="fas fa-plus"></i></button>
                        </div>
                    )}

                    {/* 4. ç³»çµ±è¨­å®š */}
                    {view==='personnel' && (
                        <div className="space-y-6">
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 font-bold text-slate-700">æ¥­å‹™ç¨®é¡</div>
                                <div className="p-4 space-y-3">
                                    <div className="flex gap-2"><input className="input-ios" placeholder="æ–°å¢ç¨®é¡..." value={newType} onChange={e=>setNewType(e.target.value)} /><button onClick={()=>{if(newType)db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general").update({taskTypes:firebase.firestore.FieldValue.arrayUnion(newType)});setNewType("")}} className="bg-slate-800 text-white px-4 rounded-lg font-bold">æ–°å¢</button></div>
                                    <div className="flex flex-wrap gap-2">{meta.taskTypes.map(t=><div key={t} className="bg-slate-100 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2">{t} <i onClick={()=>confirm("åˆªé™¤?")&&db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general").update({taskTypes:firebase.firestore.FieldValue.arrayRemove(t)})} className="fas fa-times text-slate-400 cursor-pointer"></i></div>)}</div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 font-bold text-slate-700">äººå“¡è¨­å®š</div>
                                <div className="p-4 space-y-3">
                                    <div className="flex gap-2"><input className="input-ios" placeholder="æ–°å¢äººå“¡..." value={newAuth} onChange={e=>setNewAuth(e.target.value)} /><button onClick={()=>{if(newAuth)db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general").update({authors:firebase.firestore.FieldValue.arrayUnion(newAuth)});setNewAuth("")}} className="bg-blue-600 text-white px-4 rounded-lg font-bold">æ–°å¢</button></div>
                                    <div className="divide-y">{meta.authors.map(a=><div key={a} className="py-3 flex justify-between items-center"><div><div className="font-bold text-lg">{a}</div><div className="text-xs text-slate-400 cursor-pointer" onClick={()=>setEditDef(a)}>{editDef===a?(<select className="border rounded" onChange={e=>{saveAuthorDefault(a,e.target.value);setEditDef(null)}} onBlur={()=>setEditDef(null)} autoFocus><option value="">ç„¡</option>{meta.codes.map(c=><option key={c} value={c}>{c}</option>)}</select>):`é è¨­: ${meta.authorDefaults?.[a]||"ç„¡"}`}</div></div><i onClick={()=>confirm("åˆªé™¤?")&&db.collection("artifacts").doc(APP_ID).collection("users").doc(user.uid).collection("metadata").doc("general").update({authors:firebase.firestore.FieldValue.arrayRemove(a)})} className="fas fa-trash-alt text-slate-300 hover:text-red-500 cursor-pointer p-2"></i></div>)}</div>
                                </div>
                            </div>
                        </div>
                    )}
                </main>

                {/* Task Modal */}
                {taskModal && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={()=>setTaskModal(false)}></div>
                        <div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 relative z-10 animate-[fadeIn_0.3s_ease-out] space-y-4 max-h-[80vh] overflow-y-auto">
                            <div className="flex justify-between items-center"><h2 className="text-xl font-bold">{taskForm.id?"ç·¨è¼¯":"æ–°å¢"}</h2><i onClick={()=>setTaskModal(false)} className="fas fa-times text-xl p-2 text-slate-400"></i></div>
                            <div><label className="text-xs font-bold text-slate-500">åç¨±</label><input className="input-ios" value={taskForm.title} onChange={e=>setTaskForm({...taskForm,title:e.target.value})} /></div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold text-slate-500">ç¨®é¡</label><div className="select-wrapper"><select className="input-ios" value={taskForm.type} onChange={e=>setTaskForm({...taskForm,type:e.target.value})}>{meta.taskTypes.map(t=><option key={t} value={t}>{t}</option>)}</select></div></div>
                                <div><label className="text-xs font-bold text-slate-500">é‡è¦</label><div className="select-wrapper"><select className="input-ios" value={taskForm.priority} onChange={e=>setTaskForm({...taskForm,priority:e.target.value})}><option value="æ€¥ä»¶">ğŸ”´ æ€¥ä»¶</option><option value="ä¸€èˆ¬">ğŸŸ¢ ä¸€èˆ¬</option><option value="äº¤è¾¦">ğŸŸ£ äº¤è¾¦</option></select></div></div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold text-slate-500">é–‹å§‹</label><input type="datetime-local" className="input-ios text-xs px-1" value={taskForm.startDate} onChange={e=>setTaskForm({...taskForm,startDate:e.target.value})} /></div>
                                <div><label className="text-xs font-bold text-slate-500">çµæŸ</label><input type="datetime-local" className="input-ios text-xs px-1" value={taskForm.endDate} onChange={e=>setTaskForm({...taskForm,endDate:e.target.value})} /></div>
                            </div>
                            <div><label className="text-xs font-bold text-slate-500">æé†’</label><div className="select-wrapper"><select className="input-ios" value={taskForm.reminderMinutes} onChange={e=>setTaskForm({...taskForm,reminderMinutes:e.target.value})}><option value="0">ä¸æé†’</option><option value="10">10åˆ†å‰</option><option value="30">30åˆ†å‰</option><option value="60">1å°æ™‚å‰</option><option value="1440">1å¤©å‰</option></select></div></div>
                            <div className="relative">
                                <label className="text-xs font-bold text-slate-500">å‚™è¨»/åœ–ç‰‡</label>
                                <textarea className="w-full border rounded-xl p-3 h-24" value={taskForm.notes} onChange={e=>setTaskForm({...taskForm,notes:e.target.value})}></textarea>
                                <div className="absolute bottom-3 right-3"><input type="file" ref={imgRef} accept="image/*" className="hidden" onChange={async e=>{if(e.target.files[0]){const b64=await compressImage(e.target.files[0]);setTaskForm({...taskForm,imageUrl:b64})}}} /><button onClick={()=>imgRef.current.click()} className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-600"><i className="fas fa-camera"></i></button></div>
                            </div>
                            {taskForm.imageUrl && <div className="relative mt-2"><img src={taskForm.imageUrl} className="h-32 rounded-xl object-cover border" /><i onClick={()=>setTaskForm({...taskForm,imageUrl:""})} className="fas fa-times absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center p-1"></i></div>}
                            <button onClick={saveTask} className="w-full bg-blue-600 text-white h-12 rounded-xl font-bold shadow-lg">å„²å­˜</button>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
