<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>公文發文系統 (手機版)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel，用來在瀏覽器內編譯 JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase CDN (compat 版本，提供全域 firebase 物件) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background-color: #f8fafc;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.2s ease-out;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- 這裡全部用 Babel 編譯，不再使用 import / export -->
  <script type="text/babel" data-presets="env,react">
    // ======================
    // 1. Firebase 設定
    // ======================
    const firebaseConfig = {
      apiKey: "AIzaSyAHLUkaGRW7j7ZHFaTEJMKNbkMzZm218w4",
      authDomain: "official-document-system-239ab.firebaseapp.com",
      projectId: "official-document-system-239ab",
      storageBucket: "official-document-system-239ab.firebasestorage.app",
      messagingSenderId: "285835980582",
      appId: "1:285835980582:web:feb116841184884f685be7",
      measurementId: "G-B9R46YLGXQ",
    };

    const CURRENT_APP_ID = "dispatch-system-user-v1";

    // 初始化 Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      // 防止 hot-reload 重複初始化
      console.warn("Firebase already initialized:", e?.message);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // ======================
    // 2. React App
    // ======================
    const { useState, useEffect, useMemo } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      const [form, setForm] = useState({
        id: null,
        date: new Date().toISOString().split("T")[0],
        author: "",
        code: "",
        number: "",
        subject: "",
      });

      // 匿名登入 + 監聽使用者
      useEffect(() => {
        auth
          .signInAnonymously()
          .catch((error) => {
            console.error("Auth error:", error);
            alert(
              "無法登入 Firebase，請確認：\nFirebase 專案存在，且已開啟「匿名登入」。"
            );
          });

        const unsub = auth.onAuthStateChanged((u) => {
          setUser(u || null);
        });

        return () => unsub();
      }, []);

      // 監聽 Firestore 資料
      useEffect(() => {
        if (!user) {
          setLoading(false);
          return;
        }

        const colRef = db
          .collection("artifacts")
          .doc(CURRENT_APP_ID)
          .collection("users")
          .doc(user.uid)
          .collection("records");

        const unsub = colRef
          .orderBy("createdAt", "desc")
          .onSnapshot(
            (snap) => {
              const data = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              setRecords(data);
              setLoading(false);
            },
            (err) => {
              console.error("Firestore snapshot error:", err);
              alert("讀取雲端資料失敗，請檢查 Firestore 權限設定。");
              setLoading(false);
            }
          );

        return () => unsub();
      }, [user]);

      const handleChange = (e) => {
        const { name, value } = e.target;
        setForm((prev) => ({ ...prev, [name]: value }));
      };

      // 自動產生字號（以民國年 + 流水號簡化）
      const generateNextNumber = (currentRecords) => {
        const today = new Date();
        const rocYear = today.getFullYear() - 1911;
        const prefix = String(rocYear);
        const nums = currentRecords
          .map((r) => r.number)
          .filter((n) => n && String(n).startsWith(prefix))
          .map((n) => parseInt(n, 10))
          .filter((n) => !Number.isNaN(n));

        if (nums.length === 0) return prefix + "0000001";
        const maxNum = Math.max(...nums);
        return String(maxNum + 1);
      };

      const handleSubmit = async () => {
        if (!user) {
          alert("尚未登入雲端，請稍後再試。");
          return;
        }
        if (!form.date || !form.author || !form.code || !form.subject) {
          alert("請至少填寫：日期、發文者、文電代字、主旨");
          return;
        }

        setSaving(true);

        try {
          const colRef = db
            .collection("artifacts")
            .doc(CURRENT_APP_ID)
            .collection("users")
            .doc(user.uid)
            .collection("records");

          let finalNumber = form.number;
          if (!finalNumber) {
            finalNumber = generateNextNumber(records);
          }

          const payload = {
            date: form.date,
            author: form.author,
            code: form.code,
            number: finalNumber,
            subject: form.subject,
            createdAt: new Date().toISOString(),
          };

          if (form.id) {
            // 更新
            await colRef.doc(form.id).set(payload, { merge: true });
            alert("資料已更新");
          } else {
            // 新增
            await colRef.add(payload);
            alert(`登錄成功，字號：${finalNumber}`);
          }

          // 清空主旨與字號，日期保留當天
          setForm((prev) => ({
            ...prev,
            id: null,
            number: "",
            subject: "",
          }));
        } catch (e) {
          console.error("Save error:", e);
          alert("寫入雲端失敗，請檢查 Firestore 規則與網路連線。");
        } finally {
          setSaving(false);
        }
      };

      const handleLoad = (record) => {
        setForm({
          id: record.id,
          date: record.date,
          author: record.author || "",
          code: record.code || "",
          number: record.number || "",
          subject: record.subject || "",
        });
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      const handleDelete = async (recordId) => {
        if (!user) return;
        if (!recordId) return;
        if (!confirm("確定要刪除此筆公文紀錄？")) return;

        try {
          const docRef = db
            .collection("artifacts")
            .doc(CURRENT_APP_ID)
            .collection("users")
            .doc(user.uid)
            .collection("records")
            .doc(recordId);

          await docRef.delete();
          alert("已刪除");
          if (form.id === recordId) {
            setForm((prev) => ({
              ...prev,
              id: null,
              number: "",
              subject: "",
            }));
          }
        } catch (e) {
          console.error("Delete error:", e);
          alert("刪除失敗，請檢查權限或網路。");
        }
      };

      const displayRecords = useMemo(() => {
        return records.slice(); // 目前僅簡單照 createdAt desc 顯示
      }, [records]);

      if (!user && loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-100 text-slate-500 gap-2">
            <svg
              className="animate-spin h-5 w-5 text-blue-500"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
                fill="none"
              ></circle>
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"
              ></path>
            </svg>
            連線資料庫中…
          </div>
        );
      }

      return (
        <div className="min-h-screen flex justify-center bg-slate-100">
          <div className="w-full max-w-md bg-white shadow-xl min-h-screen flex flex-col">
            {/* Header */}
            <header className="bg-blue-700 text-white px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="font-bold text-lg">公文發文系統</span>
              </div>
              <div className="text-[10px] bg-blue-900/60 px-2 py-1 rounded">
                雲端同步中
              </div>
            </header>

            {/* Form */}
            <div className="p-4 space-y-4 border-b border-slate-200 bg-slate-50">
              <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm space-y-3">
                {/* 日期 & 發文者 */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1">
                    <label className="text-xs font-semibold text-slate-600">
                      發文日期
                    </label>
                    <input
                      type="date"
                      name="date"
                      value={form.date}
                      onChange={handleChange}
                      className="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div className="space-y-1">
                    <label className="text-xs font-semibold text-slate-600">
                      發文者
                    </label>
                    <input
                      type="text"
                      name="author"
                      value={form.author}
                      onChange={handleChange}
                      placeholder="例：黃○○"
                      className="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>

                {/* 文電代字 & 字號 */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1">
                    <label className="text-xs font-semibold text-slate-600">
                      文電代字
                    </label>
                    <input
                      type="text"
                      name="code"
                      value={form.code}
                      onChange={handleChange}
                      placeholder="例：陸十平武"
                      className="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div className="space-y-1">
                    <div className="flex items-center justify-between">
                      <label className="text-xs font-semibold text-slate-600">
                        字號
                      </label>
                      <span className="text-[10px] text-slate-400">
                        留空自動帶號
                      </span>
                    </div>
                    <input
                      type="text"
                      name="number"
                      value={form.number}
                      onChange={handleChange}
                      placeholder="可留空"
                      className="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>

                {/* 主旨 */}
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-600">
                    主旨
                  </label>
                  <textarea
                    name="subject"
                    rows="3"
                    value={form.subject}
                    onChange={handleChange}
                    placeholder="輸入公文主旨…"
                    className="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                  ></textarea>
                </div>

                {/* 按鈕 */}
                <div className="grid grid-cols-2 gap-3 pt-1">
                  <button
                    onClick={handleSubmit}
                    disabled={saving}
                    className="flex items-center justify-center gap-1 rounded-lg bg-blue-600 text-white text-sm py-2 font-semibold hover:bg-blue-700 disabled:opacity-60"
                  >
                    {form.id ? "儲存修改" : "登錄公文"}
                  </button>
                  <button
                    type="button"
                    onClick={() =>
                      setForm((prev) => ({
                        ...prev,
                        id: null,
                        number: "",
                        subject: "",
                      }))
                    }
                    className="flex items-center justify-center gap-1 rounded-lg border text-sm py-2 font-semibold text-slate-600 border-slate-300 bg-slate-50"
                  >
                    清除主旨/字號
                  </button>
                </div>
              </div>
            </div>

            {/* 列表 */}
            <div className="flex-1 overflow-y-auto p-4 bg-slate-100 space-y-3">
              <div className="flex items-center justify-between mb-1">
                <div className="text-sm font-semibold text-slate-700">
                  發文紀錄
                </div>
                <div className="text-[11px] text-slate-400">
                  共 {displayRecords.length} 筆
                </div>
              </div>

              {loading && (
                <div className="text-center text-xs text-slate-400 py-4">
                  讀取中…
                </div>
              )}

              {!loading && displayRecords.length === 0 && (
                <div className="text-center text-xs text-slate-400 py-8">
                  目前尚無資料，請先登錄第一筆公文。
                </div>
              )}

              {displayRecords.map((r) => (
                <div
                  key={r.id}
                  className={
                    "bg-white rounded-lg border border-slate-200 p-3 shadow-sm text-sm space-y-1 animate-fadeIn"
                  }
                  onClick={() => handleLoad(r)}
                >
                  <div className="flex flex-wrap gap-2 text-[11px] text-slate-500">
                    <span className="px-1.5 py-0.5 rounded bg-slate-100 border border-slate-200">
                      {r.date}
                    </span>
                    <span className="px-1.5 py-0.5 rounded bg-slate-100 border border-slate-200">
                      {r.code}
                    </span>
                    <span className="px-1.5 py-0.5 rounded bg-blue-50 border border-blue-200 text-blue-700 font-semibold">
                      {r.number}
                    </span>
                    <span>{r.author}</span>
                  </div>
                  <div className="text-slate-800 leading-snug">
                    {r.subject || <span className="text-slate-400">（無主旨）</span>}
                  </div>
                  <div className="flex justify-end pt-1">
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleDelete(r.id);
                      }}
                      className="text-[11px] text-red-500 hover:text-red-600"
                    >
                      刪除
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
